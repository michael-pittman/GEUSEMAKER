# Story 13.1: CloudFront Service Implementation

## Status
Draft

## Story

**As a** user deploying Tier 3 workloads,
**I want** a CloudFront distribution to be created and configured,
**so that** my services have global content delivery and edge caching.

## Acceptance Criteria

1. CloudFront distribution is created with ALB as origin
2. Caching behaviors are configured per service path
3. SSL/TLS is configured with ACM certificate or default
4. Custom domain support is available
5. Distribution waits until deployed state
6. CloudFront domain name is returned
7. Origin access is properly configured
8. Security headers are configured
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create CloudFront Service Class (AC: 1)
  - [ ] Create `src/geusemaker/services/cloudfront_service.py`
  - [ ] Implement CloudFrontService class
  - [ ] Accept ALB DNS as origin

- [ ] Task 2: Implement Distribution Creation (AC: 1, 6)
  - [ ] Create CloudFront distribution
  - [ ] Configure ALB as custom origin
  - [ ] Set origin protocol policy
  - [ ] Return distribution ID and domain

- [ ] Task 3: Configure Caching Behaviors (AC: 2)
  - [ ] Create default cache behavior
  - [ ] Create path-specific behaviors
  - [ ] Configure TTL settings
  - [ ] Set query string forwarding

- [ ] Task 4: Configure SSL/TLS (AC: 3)
  - [ ] Support ACM certificate ARN
  - [ ] Use CloudFront default certificate
  - [ ] Configure SSL protocols
  - [ ] Set minimum protocol version

- [ ] Task 5: Support Custom Domains (AC: 4)
  - [ ] Accept alternate domain names (CNAMEs)
  - [ ] Validate domain format
  - [ ] Require ACM cert for custom domains
  - [ ] Document DNS configuration

- [ ] Task 6: Wait for Deployed State (AC: 5)
  - [ ] Poll distribution status
  - [ ] Wait until status is "Deployed"
  - [ ] Timeout after configurable period
  - [ ] Handle deployment errors

- [ ] Task 7: Configure Origin Access (AC: 7)
  - [ ] Set origin connection timeout
  - [ ] Configure origin read timeout
  - [ ] Set retry attempts
  - [ ] Configure origin shield (optional)

- [ ] Task 8: Configure Security Headers (AC: 8)
  - [ ] Add security headers policy
  - [ ] Configure HSTS
  - [ ] Set X-Content-Type-Options
  - [ ] Configure X-Frame-Options

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Test distribution creation
  - [ ] Test cache behavior configuration
  - [ ] Test SSL configuration
  - [ ] Test custom domain support
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Architecture References
- See `docs/architecture/ARCHITECTURE.md` for service layer patterns
- CloudFront service follows same patterns as ALB service
- Uses boto3 CloudFront client

### Cache Behavior Configuration
```python
CACHE_BEHAVIORS = {
    "/n8n/*": {"ttl": 0, "forward_all": True},      # No caching for n8n
    "/ollama/*": {"ttl": 0, "forward_all": True},   # No caching for Ollama
    "/qdrant/*": {"ttl": 0, "forward_all": True},   # No caching for Qdrant
    "/crawl4ai/*": {"ttl": 0, "forward_all": True}, # No caching for Crawl4AI
    "/static/*": {"ttl": 86400, "compress": True}   # Cache static assets
}
```

### Distribution Configuration
- Price class: PriceClass_100 (North America and Europe)
- HTTP/2 and HTTP/3 enabled
- IPv6 enabled
- Logging optional

### SSL Configuration
```python
SSL_CONFIG = {
    "minimum_protocol_version": "TLSv1.2_2021",
    "ssl_support_method": "sni-only"
}
```

## Testing

### Unit Tests
- Mock boto3 CloudFront client with moto
- Test distribution creation
- Test cache behavior configuration
- Test SSL/TLS setup
- Test wait for deployed state

### Integration Tests
- Create distribution with test ALB
- Verify caching behaviors
- Test custom domain (if available)
- Clean up after tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
