# Story 11.4: Failure Recovery and Rollback

## Status
Draft

## Priority Note
**⚠️ HIGH PRIORITY - BLOCKING ISSUE (2025-01-21):**
- Current `tier1.py` orchestrator has no error handling or rollback
- Failed deployments leave orphaned resources (VPC, EFS, security groups)
- No resource tracking for cleanup on failure
- State only saved at end, so partial failures have no recovery path
- Impact: Manual cleanup required after every deployment failure
- Required: Implement error handling, resource tracking, and automatic rollback

## Story

**As a** user experiencing a deployment failure,
**I want** automatic recovery and cleanup,
**so that** I don't have orphaned resources or incomplete deployments.

## Acceptance Criteria

1. Critical failures trigger automatic rollback
2. Partial deployments are cleaned up on failure
3. State is saved for manual recovery if needed
4. Recovery options are presented to user
5. Rollback can be disabled (--no-rollback)
6. Failed resource creation is logged
7. Manual intervention guidance is provided
8. Deployment status reflects failure state
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Define Critical Failures (AC: 1)
  - [ ] EC2 launch failure = critical
  - [ ] EFS mount failure = critical
  - [ ] Service health failure = recoverable

- [ ] Task 2: Implement Auto-Rollback (AC: 1, 2)
  - [ ] Track created resources
  - [ ] Trigger rollback on critical failure
  - [ ] Delete in reverse order

- [ ] Task 3: Save Partial State (AC: 3)
  - [ ] Save state on failure
  - [ ] Mark as "failed" status
  - [ ] Include error details

- [ ] Task 4: Present Recovery Options (AC: 4)
  - [ ] Retry failed step
  - [ ] Continue with warning
  - [ ] Rollback and abort
  - [ ] Manual intervention

- [ ] Task 5: Support No-Rollback (AC: 5)
  - [ ] --no-rollback flag
  - [ ] Preserve resources on failure
  - [ ] Warn user of orphans

- [ ] Task 6: Log Failed Resources (AC: 6)
  - [ ] Log resource creation attempts
  - [ ] Log deletion attempts
  - [ ] Include error details

- [ ] Task 7: Provide Intervention Guide (AC: 7)
  - [ ] AWS Console links
  - [ ] CLI commands to fix
  - [ ] Resource IDs to check

- [ ] Task 8: Update Deployment Status (AC: 8)
  - [ ] Set status to "failed"
  - [ ] Include failure reason
  - [ ] Show in list command

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Test auto-rollback
  - [ ] Test partial cleanup
  - [ ] Test recovery options
  - [ ] Achieve 80%+ coverage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
