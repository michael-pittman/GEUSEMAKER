# Story 13.4: CloudFront Integration with Deployment State

## Status
Draft

## Story

**As a** user managing Tier 3 deployments,
**I want** CloudFront information stored in deployment state,
**so that** I can inspect, update, and destroy CloudFront resources properly.

## Acceptance Criteria

1. CloudFront distribution ID is stored in state
2. CloudFront domain name is stored in state
3. GPU instance details are stored in state
4. Deployment inspection shows CloudFront info
5. CloudFront costs are included in estimation
6. CloudFront is destroyed with deployment
7. State migration handles CloudFront fields
8. List command shows CloudFront domain for Tier 3
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Extend Deployment State Schema (AC: 1, 2, 3)
  - [ ] Add cloudfront_distribution_id field
  - [ ] Add cloudfront_domain_name field
  - [ ] Add gpu_enabled boolean
  - [ ] Add gpu_instance_type field

- [ ] Task 2: Store CloudFront Info During Deployment (AC: 1, 2)
  - [ ] Save distribution ID after creation
  - [ ] Save CloudFront domain name
  - [ ] Save cache behavior configuration
  - [ ] Save origin configuration

- [ ] Task 3: Store GPU Info During Deployment (AC: 3)
  - [ ] Save GPU instance type
  - [ ] Save GPU AMI used
  - [ ] Save GPU health status
  - [ ] Save GPU memory available

- [ ] Task 4: Update Deployment Inspection (AC: 4)
  - [ ] Show CloudFront domain prominently
  - [ ] Show distribution status
  - [ ] Show cache configurations
  - [ ] Show GPU information if enabled

- [ ] Task 5: Include CloudFront in Cost Estimation (AC: 5)
  - [ ] Calculate CloudFront request costs
  - [ ] Calculate data transfer costs
  - [ ] Calculate GPU instance costs
  - [ ] Add to total deployment cost

- [ ] Task 6: Handle CloudFront in Destruction (AC: 6)
  - [ ] Disable distribution first
  - [ ] Wait for disabled state
  - [ ] Delete distribution
  - [ ] Continue with ALB destruction

- [ ] Task 7: Add State Migration for CloudFront (AC: 7)
  - [ ] Migrate v2 state to v3 with CloudFront
  - [ ] Handle missing CloudFront fields
  - [ ] Set defaults for new fields
  - [ ] Preserve GPU information

- [ ] Task 8: Update List Command (AC: 8)
  - [ ] Show CloudFront domain for Tier 3
  - [ ] Show GPU indicator
  - [ ] Show distribution status
  - [ ] Format appropriately

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Test state schema extension
  - [ ] Test CloudFront info storage
  - [ ] Test GPU info storage
  - [ ] Test inspection output
  - [ ] Test cost estimation
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Architecture References
- See `docs/architecture/ARCHITECTURE.md` for state management
- State schema versioned for migration support
- Extends Tier 2 state schema

### State Schema Extension
```python
class DeploymentState(BaseModel):
    # Existing fields (Tier 1 + 2)...

    # Tier 3 CloudFront fields
    cloudfront_distribution_id: Optional[str] = None
    cloudfront_domain_name: Optional[str] = None
    cloudfront_status: Optional[str] = None

    # GPU fields
    gpu_enabled: bool = False
    gpu_instance_type: Optional[str] = None
    gpu_ami_id: Optional[str] = None
```

### Cost Estimation
```python
CLOUDFRONT_COSTS = {
    "request_per_10k": 0.0085,     # per 10,000 requests
    "data_transfer_gb": 0.085,     # per GB
    "ssl_cert": 0.0,               # free with ACM
}

GPU_COSTS = {  # per hour (on-demand)
    "g4dn.xlarge": 0.526,
    "g4dn.2xlarge": 0.752,
    "g5.xlarge": 1.006,
    "g5.2xlarge": 1.212,
    "p3.2xlarge": 3.06,
}
```

### Destruction Order
```
1. Disable CloudFront distribution
2. Wait for disabled state (~15 min)
3. Delete CloudFront distribution
4. (Continue with ALB destruction)
5. (Continue with EC2, EFS, etc.)
```

### CloudFront Deletion Note
- CloudFront must be disabled before deletion
- Disable operation takes ~15 minutes
- Consider async destruction option

## Testing

### Unit Tests
- Test state schema with CloudFront fields
- Test serialization/deserialization
- Test inspection formatting
- Test cost calculations
- Test destruction sequence

### Integration Tests
- Create Tier 3 deployment
- Verify state contains CloudFront info
- Run inspection command
- Destroy and verify cleanup

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
