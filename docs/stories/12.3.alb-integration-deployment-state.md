# Story 12.3: ALB Integration with Deployment State

## Status
Draft

## Story

**As a** user managing Tier 2 deployments,
**I want** ALB information stored in deployment state,
**so that** I can inspect, update, and destroy ALB resources properly.

## Acceptance Criteria

1. ALB ARN and DNS are stored in deployment state
2. Target group ARNs are stored in deployment state
3. Deployment inspection shows ALB information
4. ALB costs are included in cost estimation
5. ALB resources are destroyed with deployment
6. State migration handles ALB fields
7. List command shows ALB DNS for Tier 2
8. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Extend Deployment State Schema (AC: 1, 2)
  - [ ] Add alb_arn field
  - [ ] Add alb_dns_name field
  - [ ] Add target_groups dictionary
  - [ ] Add listener_arns list

- [ ] Task 2: Store ALB Info During Deployment (AC: 1, 2)
  - [ ] Save ALB ARN after creation
  - [ ] Save ALB DNS name
  - [ ] Save target group ARNs
  - [ ] Save listener ARNs

- [ ] Task 3: Update Deployment Inspection (AC: 3)
  - [ ] Show ALB DNS name prominently
  - [ ] List target groups
  - [ ] Show listener configurations
  - [ ] Show target health status

- [ ] Task 4: Include ALB in Cost Estimation (AC: 4)
  - [ ] Calculate ALB hourly cost
  - [ ] Calculate LCU usage estimate
  - [ ] Add to total deployment cost
  - [ ] Show breakdown in inspection

- [ ] Task 5: Handle ALB in Destruction (AC: 5)
  - [ ] Deregister targets first
  - [ ] Delete listeners
  - [ ] Delete target groups
  - [ ] Delete ALB last
  - [ ] Handle partial deletion

- [ ] Task 6: Add State Migration for ALB (AC: 6)
  - [ ] Migrate v1 state to v2 with ALB fields
  - [ ] Handle missing ALB fields gracefully
  - [ ] Set defaults for new fields

- [ ] Task 7: Update List Command (AC: 7)
  - [ ] Show "Tier" column
  - [ ] Show ALB DNS for Tier 2
  - [ ] Indicate ALB health status
  - [ ] Format DNS name appropriately

- [ ] Task 8: Create Unit Tests (AC: 8)
  - [ ] Test state schema extension
  - [ ] Test ALB info storage
  - [ ] Test inspection output
  - [ ] Test cost estimation
  - [ ] Test destruction sequence
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Architecture References
- See `docs/architecture/ARCHITECTURE.md` for state management
- State schema versioned for migration support
- Uses same state file format as Tier 1

### State Schema Extension
```python
class DeploymentState(BaseModel):
    # Existing fields...

    # Tier 2 ALB fields
    tier: int = 1
    alb_arn: Optional[str] = None
    alb_dns_name: Optional[str] = None
    target_groups: Dict[str, str] = {}  # service -> target_group_arn
    listener_arns: List[str] = []
```

### Cost Estimation
```python
ALB_COSTS = {
    "alb_hour": 0.0225,  # per hour
    "lcu_hour": 0.008,   # per LCU-hour
    "estimated_lcu": 1   # baseline estimate
}
```

### Destruction Order
```
1. Deregister targets
2. Delete listener rules
3. Delete listeners
4. Delete target groups
5. Delete ALB
6. (Continue with EC2, EFS, etc.)
```

## Testing

### Unit Tests
- Test state schema with ALB fields
- Test serialization/deserialization
- Test inspection formatting
- Test cost calculations
- Test destruction sequence

### Integration Tests
- Create Tier 2 deployment
- Verify state contains ALB info
- Run inspection command
- Destroy and verify cleanup

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
