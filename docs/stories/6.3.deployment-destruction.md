# Story 6.3: Deployment Destruction Command

## Status
Done

## Story

**As a** developer finished with a deployment,
**I want** to safely destroy all deployment resources,
**so that** I can stop incurring costs and clean up AWS resources properly.

## Acceptance Criteria

1. `geusemaker destroy <name>` terminates and cleans up a deployment
2. Destruction requires explicit confirmation (type deployment name)
3. Destruction only deletes resources created by GeuseMaker (not reused)
4. Resources are deleted in correct dependency order
5. Destruction preserves reused resources (based on provenance)
6. Destruction generates a deletion report
7. Deployment state is archived after destruction
8. `--force` flag skips confirmation for automation
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Destroy Command (AC: 1, 2, 8)
  - [ ] Create `geusemaker/cli/commands/destroy.py`
  - [ ] Implement `destroy` Click command
  - [ ] Require name confirmation (type name to confirm)
  - [ ] Support `--force` for automation
  - [ ] Handle deployment not found

- [ ] Task 2: Create Destruction Service (AC: 3, 4)
  - [ ] Create `geusemaker/services/destruction/__init__.py`
  - [ ] Create `geusemaker/services/destruction/service.py`
  - [ ] Implement `DestructionService` class
  - [ ] Implement `destroy(deployment: DeploymentState) -> DestructionResult`
  - [ ] Coordinate deletion in dependency order

- [ ] Task 3: Implement Resource Deletion Order (AC: 4)
  - [ ] Delete EC2 instance first
  - [ ] Delete EFS mount targets
  - [ ] Delete EFS file system (if created by GeuseMaker)
  - [ ] Delete security groups
  - [ ] Delete subnets (if created by GeuseMaker)
  - [ ] Delete Internet Gateway (if created)
  - [ ] Delete VPC (if created by GeuseMaker)
  - [ ] Delete ALB and target groups (Tier 2+)
  - [ ] Delete CloudFront distribution (Tier 3)

- [ ] Task 4: Implement Provenance-Based Deletion (AC: 3, 5)
  - [ ] Check provenance for each resource
  - [ ] Only delete resources with provenance = CREATED
  - [ ] Skip resources with provenance = REUSED
  - [ ] Log skipped resources with reason

- [ ] Task 5: Implement EC2 Termination (AC: 3)
  - [ ] Terminate EC2 instance
  - [ ] Wait for instance to be terminated
  - [ ] Handle spot instance termination
  - [ ] Delete associated EBS volumes

- [ ] Task 6: Implement EFS Deletion (AC: 3, 4)
  - [ ] Delete mount targets first
  - [ ] Wait for mount targets to be deleted
  - [ ] Delete file system
  - [ ] Handle deletion dependencies

- [ ] Task 7: Implement Destruction Report (AC: 6)
  - [ ] Generate report of deleted resources
  - [ ] Include preserved (reused) resources
  - [ ] Include deletion errors/warnings
  - [ ] Display summary table
  - [ ] Support JSON export

- [ ] Task 8: Implement State Archival (AC: 7)
  - [ ] Update deployment status to "terminated"
  - [ ] Move state to archive directory
  - [ ] Keep archived state for audit
  - [ ] Add terminated_at timestamp

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_destruction/test_service.py`
  - [ ] Test destruction order is correct
  - [ ] Test provenance-based deletion
  - [ ] Test confirmation requirement
  - [ ] Test force flag bypasses confirmation
  - [ ] Test state archival
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 2.4: Provenance tracking identifies created vs reused resources.
From Story 4.6: Orchestrator creates resources in dependency order.

### Data Models
[Source: architecture/4-data-models.md]

**DestructionResult Model (new):**
- `success`: bool
- `deleted_resources`: list[DeletedResource]
- `preserved_resources`: list[PreservedResource]
- `errors`: list[str]
- `duration_seconds`: float
- `archived_state_path`: str

**DeletedResource Model (new):**
- `resource_type`: str
- `resource_id`: str
- `deleted_at`: datetime
- `deletion_time_seconds`: float

**PreservedResource Model (new):**
- `resource_type`: str
- `resource_id`: str
- `reason`: str (e.g., "Reused existing resource")

### CLI Specifications
[Source: architecture/5-components.md#5.1]

**Destroy Command Usage:**
```bash
# Destroy with confirmation
geusemaker destroy my-dev-stack
# Prompts: "Type 'my-dev-stack' to confirm destruction:"

# Force destruction (for automation)
geusemaker destroy my-dev-stack --force

# Dry run (show what would be deleted)
geusemaker destroy my-dev-stack --dry-run
```

**Destruction Display:**
```
╭──────────── Destroying: my-dev-stack ────────────╮
│                                                   │
│  ⚠️  This will permanently delete resources!      │
│                                                   │
│  Resources to DELETE:                            │
│  • EC2 Instance: i-12345678                      │
│  • EFS: fs-12345678                              │
│  • Security Group: sg-12345678                   │
│  • VPC: vpc-12345678                             │
│                                                   │
│  Resources to PRESERVE (reused):                 │
│  • Key Pair: my-existing-key                     │
│                                                   │
│  Type 'my-dev-stack' to confirm: _               │
╰───────────────────────────────────────────────────╯
```

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
├── services/
│   └── destruction/
│       ├── __init__.py
│       └── service.py      # Destruction service
├── cli/
│   └── commands/
│       └── destroy.py      # Destroy command
tests/
├── unit/
│   └── test_services/
│       └── test_destruction/
│           └── test_service.py
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- EFS deletion requires all mount targets deleted first
- Security groups can't be deleted if referenced
- VPC deletion requires all resources removed first
- Some deletions may take several minutes
- Handle partial deletion failures gracefully

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test resources deleted in correct order
2. Test reused resources are preserved
3. Test confirmation is required
4. Test force flag works
5. Test dry run shows resources without deleting
6. Test state is archived
7. Test error handling for deletion failures

**Mocking Strategy:**
- Mock AWS deletion APIs
- Test deletion order with dependencies
- Test provenance-based decisions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results

**Reviewed by:** Quinn (QA Agent)  
**Review Date:** 2025-01-21  
**Status:** ✅ **APPROVED WITH ENHANCEMENT RECOMMENDATIONS**

### Strengths
- ✅ Excellent safety measures (explicit confirmation, type name)
- ✅ Provenance-based deletion logic (reused vs created)
- ✅ Correct dependency order for resource deletion
- ✅ Comprehensive destruction report
- ✅ State archival for audit trail
- ✅ Force flag for automation scenarios

### Issues Identified

1. **⚠️ Task 3 - Tier Validation Missing**
   - **Issue**: Deletion order mentions ALB/CloudFront but doesn't validate tier
   - **Impact**: May attempt to delete resources that don't exist for Tier 1 deployments
   - **Recommendation**: Add subtask to check deployment tier before attempting ALB/CloudFront deletion
   - **Priority**: Medium

2. **⚠️ Task 4 - Provenance Dependency**
   - **Issue**: Provenance checking requires Epic 2 implementation
   - **Impact**: Cannot implement provenance-based deletion without provenance tracking
   - **Dependency Status**: ✅ **VERIFIED** - Story 2.4 (Provenance Tracking) is Done
   - **Recommendation**: Implementation can proceed; provenance tracking is available
   - **Priority**: Low (dependency satisfied)

3. **⚠️ Partial Deletion Failure Handling**
   - **Issue**: Mentioned in constraints ("Handle partial deletion failures gracefully") but not in tasks
   - **Impact**: No explicit implementation for handling partial failures
   - **Recommendation**: Add explicit task:
     - Task 10: Implement Partial Failure Handling
       - [ ] Detect deletion failures
       - [ ] Retry failed deletions with exponential backoff
       - [ ] Continue with remaining resources
       - [ ] Report partial failures in destruction report
       - [ ] Provide manual cleanup instructions for failed resources
   - **Priority**: High

4. **ℹ️ Task 5 - EBS Volume Deletion**
   - **Issue**: Mentions deleting EBS volumes but doesn't specify deletion policy
   - **Impact**: May delete volumes that should be preserved
   - **Recommendation**: Clarify that only root volumes are deleted; data volumes should be preserved or explicitly deleted based on configuration
   - **Priority**: Low

5. **ℹ️ Task 9 - Integration Tests**
   - **Issue**: Only unit tests mentioned; destruction is critical operation
   - **Impact**: May miss integration issues
   - **Recommendation**: Add integration test requirements for end-to-end destruction flow
   - **Priority**: Medium

### Dependency Validation
- ✅ Epic 4 dependency correctly identified
- ✅ Epic 2 dependency (provenance) - **VERIFIED**: Story 2.4 is Done
- ✅ Story 2.4 and 4.6 references are appropriate

### Test Coverage Assessment
- ✅ Test cases cover major destruction scenarios
- ✅ Mocking strategy is appropriate
- ⚠️ **CRITICAL**: Add integration tests for destruction flow (high priority for safety)

### Overall Assessment
Story is well-structured with excellent safety measures. Provenance dependency is satisfied. **Critical gap**: Partial failure handling needs explicit implementation. Tier validation should be added before ALB/CloudFront deletion attempts.
