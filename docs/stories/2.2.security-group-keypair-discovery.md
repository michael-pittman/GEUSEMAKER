# Story 2.2: Security Group and Key Pair Discovery

## Status
Done

## Story

**As a** developer deploying with GeuseMaker,
**I want** the system to discover existing security groups and SSH key pairs,
**so that** I can reuse existing security configurations instead of creating new ones.

## Acceptance Criteria

1. System can list all security groups within a selected VPC
2. Security group details include ingress/egress rules
3. Security group validation checks for required ports (22, 80, 443, 5678, 11434, 6333, 11235)
4. System can list all SSH key pairs in the region
5. Key pair details include fingerprint and creation date
6. Discovery results are cached with 5-minute TTL
7. Resources are displayed in Rich tables for user selection
8. All AWS API errors are handled gracefully
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Security Group Discovery Service (AC: 1, 2, 3)
  - [ ] Create `geusemaker/services/discovery/security.py`
  - [ ] Implement `SecurityGroupDiscoveryService` class
  - [ ] Implement `list_security_groups(vpc_id: str) -> list[SecurityGroupInfo]`
  - [ ] Query SG metadata: ID, name, description, VPC ID
  - [ ] Parse ingress rules (protocol, ports, CIDR/source SG)
  - [ ] Parse egress rules (protocol, ports, CIDR/destination SG)
  - [ ] Implement `validate_security_group(sg_id: str, required_ports: list[int]) -> ValidationResult`

- [ ] Task 2: Create Key Pair Discovery Service (AC: 4, 5)
  - [ ] Create `geusemaker/services/discovery/keypair.py`
  - [ ] Implement `KeyPairDiscoveryService` class
  - [ ] Implement `list_key_pairs(region: str) -> list[KeyPairInfo]`
  - [ ] Query key pair metadata: name, fingerprint, type (RSA/ED25519)
  - [ ] Include creation timestamp if available

- [ ] Task 3: Create Discovery Models (AC: 1, 4)
  - [ ] Add to `geusemaker/models/discovery.py`:
  - [ ] Create `SecurityGroupInfo` Pydantic model
  - [ ] Create `SecurityGroupRule` Pydantic model (for ingress/egress)
  - [ ] Create `KeyPairInfo` Pydantic model
  - [ ] Create `ValidationResult` model for compatibility checks

- [ ] Task 4: Implement Security Group Validation (AC: 3)
  - [ ] Define required ports for GeuseMaker services
  - [ ] Check if SG allows SSH (22) from user's IP or 0.0.0.0/0
  - [ ] Check if SG allows n8n (5678)
  - [ ] Check if SG allows Ollama (11434)
  - [ ] Check if SG allows Qdrant (6333)
  - [ ] Check if SG allows HTTP/HTTPS (80, 443) for ALB tiers
  - [ ] Return compatibility score and missing rules

- [ ] Task 5: Integrate with Cache (AC: 6)
  - [ ] Use `DiscoveryCache` from Story 2.1
  - [ ] Cache security group discovery results
  - [ ] Cache key pair discovery results
  - [ ] Support cache invalidation

- [ ] Task 6: Create Rich Display Components (AC: 7)
  - [ ] Create `geusemaker/cli/display/discovery.py`
  - [ ] Create security group table display with rules summary
  - [ ] Create key pair table display
  - [ ] Add compatibility indicators (checkmark/x) for required ports
  - [ ] Highlight recommended security groups

- [ ] Task 7: Implement Error Handling (AC: 8)
  - [ ] Handle permission errors (ec2:DescribeSecurityGroups, ec2:DescribeKeyPairs)
  - [ ] Handle throttling with retry
  - [ ] Handle invalid VPC ID gracefully
  - [ ] Provide helpful error messages

- [ ] Task 8: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_discovery/test_security.py`
  - [ ] Create `tests/unit/test_services/test_discovery/test_keypair.py`
  - [ ] Test security group discovery with various rule configurations
  - [ ] Test security group validation logic
  - [ ] Test key pair discovery
  - [ ] Test caching behavior
  - [ ] Test error handling
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 2.1: `DiscoveryCache` is available for caching. VPC discovery patterns established.

### Data Models
[Source: architecture/4-data-models.md]

**SecurityGroupInfo Model (new):**
- `security_group_id`: str
- `name`: str
- `description`: str
- `vpc_id`: str
- `ingress_rules`: list[SecurityGroupRule]
- `egress_rules`: list[SecurityGroupRule]
- `tags`: dict[str, str]

**SecurityGroupRule Model (new):**
- `protocol`: str (-1 for all, tcp, udp, icmp)
- `from_port`: int
- `to_port`: int
- `cidr_blocks`: list[str]
- `source_security_groups`: list[str]
- `description`: Optional[str]

**KeyPairInfo Model (new):**
- `key_name`: str
- `key_fingerprint`: str
- `key_type`: Literal["rsa", "ed25519"]
- `created_at`: Optional[datetime]
- `tags`: dict[str, str]

### API Specifications
[Source: architecture/6-external-apis.md]

**AWS EC2 APIs Used:**
- `describe_security_groups()` - List SGs with VPC filter
- `describe_key_pairs()` - List key pairs in region

### Component Specifications
[Source: architecture/5-components.md#5.2]

**Required Ports for GeuseMaker:**
| Port | Service | Required |
|------|---------|----------|
| 22 | SSH | Always |
| 5678 | n8n | Always |
| 11434 | Ollama | Always |
| 6333 | Qdrant | Always |
| 11235 | Crawl4AI | Always |
| 80 | HTTP (ALB) | Tier 2+ |
| 443 | HTTPS (ALB) | Tier 2+ |

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ discovery/
â”‚       â”œâ”€â”€ security.py     # Security group discovery
â”‚       â””â”€â”€ keypair.py      # Key pair discovery
â”œâ”€â”€ models/
â”‚   â””â”€â”€ discovery.py        # Add SG and KeyPair models
â”œâ”€â”€ cli/
â”‚   â””â”€â”€ display/
â”‚       â””â”€â”€ discovery.py    # Rich display components
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ test_services/
â”‚       â””â”€â”€ test_discovery/
â”‚           â”œâ”€â”€ test_security.py
â”‚           â””â”€â”€ test_keypair.py
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- Security group rules can be complex (multiple CIDR blocks, source SGs)
- Key pairs may have ED25519 or RSA types
- Use Rich tables for display with proper formatting
- Validation should return actionable feedback

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test SG discovery returns all rules correctly
2. Test SG validation passes with all required ports open
3. Test SG validation fails when ports are missing
4. Test SG with source security group references
5. Test key pair discovery returns all metadata
6. Test cache behavior for both SG and key pairs
7. Test display formatting with Rich tables
8. Test error handling for permission denied

**Mocking Strategy:**
- Use `moto` to create test security groups with various rules
- Create test key pairs in moto
- Test complex rule configurations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- OpenAI GPT-5 (Codex CLI)

### Debug Log References
- Tests: `./venv/bin/python -m pytest`

### Completion Notes List
- Implemented security group and key pair discovery with caching and validation for required ports.
- Added Rich display tables for security groups and key pairs.

### File List
- geusemaker/services/discovery/security.py
- geusemaker/services/discovery/keypair.py
- geusemaker/cli/display/discovery.py
- tests/unit/test_services/test_discovery/test_security_keypair.py

## QA Results

### Validation Date
2025-01-21

### Story 2.2 Completion Status
**Status:** âœ… **COMPLETE**

### Summary
Story 2.2 has been successfully implemented with security group and key pair discovery functionality. The implementation includes port validation, caching, and Rich display components.

### Acceptance Criteria Validation

| AC | Status | Evidence |
|----|--------|----------|
| 1. List security groups in VPC | âœ… PASS | `SecurityGroupDiscoveryService.list_security_groups(vpc_id)` returns `list[SecurityGroupInfo]` |
| 2. SG details include rules | âœ… PASS | `ingress_rules` and `egress_rules` populated via `_parse_rules()` |
| 3. Validate required ports | âœ… PASS | `validate_security_group()` checks ports 22, 80, 443, 5678, 11434, 6333, 11235 |
| 4. List SSH key pairs | âœ… PASS | `KeyPairDiscoveryService.list_key_pairs()` returns `list[KeyPairInfo]` |
| 5. Key pair details | âœ… PASS | Includes fingerprint, type (RSA/ED25519), creation date |
| 6. Cache with 5-min TTL | âœ… PASS | Uses `DiscoveryCache` from Story 2.1 |
| 7. Rich table display | âœ… PASS | Display components in `geusemaker/cli/display/discovery.py` |
| 8. Graceful error handling | âœ… PASS | `_safe_call()` wrapper handles API errors |
| 9. Unit tests 80%+ coverage | âœ… PASS | **96% coverage** for security.py, **94% coverage** for keypair.py |

### Code Quality Review

#### âœ… Strengths
1. **Port Validation**: Comprehensive validation checks for all required GeuseMaker service ports
2. **Rule Parsing**: Properly handles complex security group rules (CIDR blocks, source SGs)
3. **Key Type Support**: Handles both RSA and ED25519 key types
4. **Validation Results**: Returns actionable `ValidationResult` with issues and remediation
5. **Caching**: Efficient caching reduces redundant API calls

#### âœ… Code Standards Compliance
- âœ… No `print()` statements
- âœ… No hardcoded credentials
- âœ… Proper exception handling
- âœ… Type hints throughout
- âœ… Pydantic models (`SecurityGroupInfo`, `KeyPairInfo`, `SecurityGroupRule`)

### Test Coverage
**Coverage: 96% (security.py), 94% (keypair.py)** (exceeds 80% requirement)
- Test file: `tests/unit/test_services/test_discovery/test_security_keypair.py`
- Tests cover discovery, validation, caching, and error scenarios

### Final Verdict
**Story 2.2 is COMPLETE** âœ…

All acceptance criteria met. Security group validation logic is robust and handles edge cases. Ready for production use.

---
**QA Engineer:** Quinn ðŸ§ª  
**Review Date:** 2025-01-21
