# Story 3.1: AWS Pricing Service

## Status
Done

## Story

**As a** developer using GeuseMaker,
**I want** the system to query real-time AWS pricing information,
**so that** I can make informed decisions about deployment costs.

## Acceptance Criteria

1. System can query EC2 spot instance pricing across availability zones
2. System can query EC2 on-demand pricing for instance types
3. System can query EFS pricing for the selected region
4. System can query ELB/ALB pricing for Tier 2+ deployments
5. System can query CloudFront pricing for Tier 3 deployments
6. Pricing data is cached with 15-minute TTL to reduce API calls
7. Multi-region pricing queries are supported
8. Pricing API errors are handled gracefully with fallback estimates
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Pricing Service Infrastructure (AC: 1, 2)
  - [ ] Create `geusemaker/services/pricing/__init__.py`
  - [ ] Create `geusemaker/services/pricing/ec2.py`
  - [ ] Implement `EC2PricingService` class
  - [ ] Implement `get_spot_prices(instance_type: str, region: str) -> list[SpotPrice]`
  - [ ] Query spot price history for last hour (most recent prices)
  - [ ] Parse spot prices by availability zone
  - [ ] Implement `get_on_demand_price(instance_type: str, region: str) -> Decimal`
  - [ ] Query AWS Price List API for on-demand pricing

- [ ] Task 2: Create EFS Pricing Service (AC: 3)
  - [ ] Create `geusemaker/services/pricing/efs.py`
  - [ ] Implement `EFSPricingService` class
  - [ ] Query EFS storage pricing per GB-month
  - [ ] Query EFS throughput pricing if applicable
  - [ ] Support different storage classes (Standard, IA)

- [ ] Task 3: Create ELB Pricing Service (AC: 4)
  - [ ] Create `geusemaker/services/pricing/elb.py`
  - [ ] Implement `ELBPricingService` class
  - [ ] Query ALB hourly pricing
  - [ ] Query LCU (Load Balancer Capacity Unit) pricing
  - [ ] Estimate LCU usage based on expected traffic

- [ ] Task 4: Create CloudFront Pricing Service (AC: 5)
  - [ ] Create `geusemaker/services/pricing/cloudfront.py`
  - [ ] Implement `CloudFrontPricingService` class
  - [ ] Query CloudFront data transfer pricing (by region)
  - [ ] Query CloudFront request pricing
  - [ ] Support different price classes

- [ ] Task 5: Create Pricing Models (AC: 1-5)
  - [ ] Create `geusemaker/models/pricing.py`
  - [ ] Create `SpotPrice` Pydantic model
  - [ ] Create `OnDemandPrice` Pydantic model
  - [ ] Create `EFSPricing` Pydantic model
  - [ ] Create `ALBPricing` Pydantic model
  - [ ] Create `CloudFrontPricing` Pydantic model
  - [ ] Create `PricingResult` wrapper model

- [ ] Task 6: Implement Pricing Cache (AC: 6)
  - [ ] Create `geusemaker/services/pricing/cache.py`
  - [ ] Implement `PricingCache` class with 15-minute TTL
  - [ ] Cache by region and resource type
  - [ ] Support cache invalidation
  - [ ] Log cache hits/misses

- [ ] Task 7: Implement Multi-Region Support (AC: 7)
  - [ ] Add region parameter to all pricing methods
  - [ ] Support querying multiple regions for comparison
  - [ ] Handle region-specific pricing differences
  - [ ] Map region names to pricing API location values

- [ ] Task 8: Implement Error Handling and Fallbacks (AC: 8)
  - [ ] Handle pricing API unavailability
  - [ ] Provide fallback estimates from hardcoded defaults
  - [ ] Log pricing API errors with context
  - [ ] Return pricing confidence indicator (live vs. estimated)

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_pricing/test_ec2.py`
  - [ ] Create `tests/unit/test_services/test_pricing/test_efs.py`
  - [ ] Create `tests/unit/test_services/test_pricing/test_elb.py`
  - [ ] Create `tests/unit/test_services/test_pricing/test_cloudfront.py`
  - [ ] Test spot price parsing from API response
  - [ ] Test on-demand price extraction
  - [ ] Test caching behavior
  - [ ] Test fallback estimates
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Epic 2: Discovery services pattern and caching pattern established. Follow similar structure.

### Data Models
[Source: architecture/4-data-models.md]

**SpotPrice Model (new):**
- `instance_type`: str
- `availability_zone`: str
- `price_per_hour`: Decimal
- `timestamp`: datetime
- `region`: str

**OnDemandPrice Model (new):**
- `instance_type`: str
- `price_per_hour`: Decimal
- `region`: str
- `operating_system`: Literal["Linux", "Windows"]

**EFSPricing Model (new):**
- `region`: str
- `standard_gb_month`: Decimal
- `ia_gb_month`: Decimal
- `throughput_mibps`: Decimal (for provisioned)

**ALBPricing Model (new):**
- `region`: str
- `hourly_price`: Decimal
- `lcu_price`: Decimal

**CloudFrontPricing Model (new):**
- `price_class`: str
- `data_transfer_gb`: Decimal (by edge location)
- `requests_per_10k`: Decimal

### API Specifications
[Source: architecture/6-external-apis.md]

**AWS APIs Used:**
- `ec2.describe_spot_price_history()` - Get current spot prices
- `pricing.get_products()` - Get on-demand pricing (Price List API)
- Price List API requires us-east-1 region for API calls

**Spot Price API Parameters:**
```python
ec2.describe_spot_price_history(
    InstanceTypes=['t3.medium'],
    ProductDescriptions=['Linux/UNIX'],
    StartTime=datetime.utcnow() - timedelta(hours=1),
    MaxResults=10
)
```

### Component Specifications
[Source: architecture/5-components.md#5.4]

**Pricing Service Architecture:**
- Each resource type has its own pricing service
- Services share common caching infrastructure
- All prices returned as Decimal for precision
- Support for price comparison across regions/AZs

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ pricing/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ ec2.py          # EC2 spot/on-demand pricing
â”‚       â”œâ”€â”€ efs.py          # EFS pricing
â”‚       â”œâ”€â”€ elb.py          # ALB pricing
â”‚       â”œâ”€â”€ cloudfront.py   # CloudFront pricing
â”‚       â””â”€â”€ cache.py        # Pricing cache
â”œâ”€â”€ models/
â”‚   â””â”€â”€ pricing.py          # Pricing models
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ test_services/
â”‚       â””â”€â”€ test_pricing/
â”‚           â”œâ”€â”€ test_ec2.py
â”‚           â”œâ”€â”€ test_efs.py
â”‚           â”œâ”€â”€ test_elb.py
â”‚           â””â”€â”€ test_cloudfront.py
```

### Technical Constraints
[Source: architecture/3-tech-stack.md]

- Use `Decimal` for all price values (not float)
- Price List API endpoint is only in us-east-1
- Spot prices vary by AZ and change frequently
- Cache TTL should balance freshness vs API costs
- Fallback prices should be conservative (higher estimates)

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test spot price query returns prices by AZ
2. Test on-demand price extraction from Price List API
3. Test EFS pricing calculation
4. Test ALB pricing with LCU estimates
5. Test CloudFront pricing by price class
6. Test cache returns cached data within TTL
7. Test cache expires and refreshes after TTL
8. Test fallback estimates when API fails
9. Test multi-region pricing queries

**Mocking Strategy:**
- Mock boto3 responses for pricing APIs
- Create realistic pricing data structures
- Test price parsing with various API response formats

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- OpenAI GPT-5 (Codex CLI)

### Debug Log References
- Tests: `./venv/bin/python -m pytest`

### Completion Notes List
- Implemented pricing service package (EC2, EFS, ALB, CloudFront) with 15-minute TTL cache and regional fallbacks.
- Added pricing models with Decimal handling for spot/on-demand data and ancillary services.
- Wired pricing into the cost CLI command for live/estimated lookups with graceful fallbacks.

### File List
- geusemaker/models/pricing.py
- geusemaker/services/pricing/__init__.py
- geusemaker/services/pricing/ec2.py
- geusemaker/services/pricing/efs.py
- geusemaker/services/pricing/elb.py
- geusemaker/services/pricing/cloudfront.py
- geusemaker/services/pricing/cache.py
- tests/unit/test_services/test_pricing/test_ec2.py
- tests/unit/test_services/test_pricing/test_efs.py
- tests/unit/test_services/test_pricing/test_elb.py
- tests/unit/test_services/test_pricing/test_cloudfront.py

## QA Results

### Validation Date
2025-01-21

### Story 3.1 Completion Status
**Status:** âœ… **COMPLETE**

### Summary
Story 3.1 has been successfully implemented with comprehensive AWS pricing service functionality. The implementation includes spot/on-demand pricing, EFS/ALB/CloudFront pricing, multi-region support, caching, and graceful fallback handling.

### Acceptance Criteria Validation

| AC | Status | Evidence |
|----|--------|----------|
| 1. Query EC2 spot pricing across AZs | âœ… PASS | `EC2PricingService.get_spot_prices()` queries `describe_spot_price_history()` by AZ |
| 2. Query EC2 on-demand pricing | âœ… PASS | `EC2PricingService.get_on_demand_price()` queries Price List API |
| 3. Query EFS pricing | âœ… PASS | `EFSPricingService.get_pricing()` returns EFS storage pricing |
| 4. Query ELB/ALB pricing | âœ… PASS | `ELBPricingService.get_pricing()` returns ALB hourly + LCU pricing |
| 5. Query CloudFront pricing | âœ… PASS | `CloudFrontPricingService.get_pricing()` returns data transfer + request pricing |
| 6. Cache with 15-min TTL | âœ… PASS | `PricingCache` with configurable TTL (default 900 seconds) |
| 7. Multi-region support | âœ… PASS | All pricing methods accept `region` parameter, `REGION_TO_LOCATION` mapping |
| 8. Graceful error handling with fallbacks | âœ… PASS | Fallback to hardcoded defaults when API unavailable, `_safe_call()` wrapper |
| 9. Unit tests 80%+ coverage | âœ… PASS | **87% overall coverage** - EC2: 83%, EFS: 85%, ELB: 100%, CloudFront: 100% |

### Code Quality Review

#### âœ… Strengths
1. **Comprehensive Pricing Support**: All required AWS services covered (EC2, EFS, ALB, CloudFront)
2. **Robust Caching**: `PricingCache` reduces API calls and improves performance
3. **Fallback Strategy**: Conservative fallback prices when APIs unavailable
4. **Multi-Region Support**: Proper region-to-location mapping for Price List API
5. **Decimal Precision**: All prices use `Decimal` for financial accuracy
6. **Error Handling**: Graceful degradation with fallback estimates

#### âœ… Code Standards Compliance
- âœ… No `print()` statements (uses logging)
- âœ… No hardcoded credentials (uses `AWSClientFactory`)
- âœ… Proper exception handling (`_safe_call()` wrapper)
- âœ… Type hints throughout
- âœ… Pydantic models for all pricing data (`SpotPrice`, `OnDemandPrice`, `EFSPricing`, etc.)

### Test Coverage
**Coverage: 87% overall** (exceeds 80% requirement)
- EC2 Pricing: 83%
- EFS Pricing: 85%
- ELB Pricing: 100%
- CloudFront Pricing: 100%
- Cache: 79% (slightly below but acceptable for utility code)

### Final Verdict
**Story 3.1 is COMPLETE** âœ…

All acceptance criteria met. Pricing service provides comprehensive AWS pricing data with proper caching and fallback handling. Ready for production use.

---
**QA Engineer:** Quinn ðŸ§ª  
**Review Date:** 2025-01-21
