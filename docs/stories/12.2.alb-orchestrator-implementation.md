# Story 12.2: ALB Orchestrator Implementation

## Status
Draft

## Story

**As a** user deploying Tier 2 workloads,
**I want** the deployment orchestrator to coordinate ALB creation,
**so that** my deployment includes load balancing with proper sequencing.

## Acceptance Criteria

1. Tier 2 orchestrator extends base orchestrator
2. ALB creation is coordinated after EC2 instances
3. EC2 instances are registered with target groups
4. Orchestrator waits for targets to become healthy
5. Deployment fails gracefully if ALB creation fails
6. Rollback removes ALB resources on failure
7. Progress is reported during ALB deployment
8. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Tier 2 Orchestrator (AC: 1)
  - [ ] Create `src/geusemaker/orchestrators/tier2_orchestrator.py`
  - [ ] Extend base orchestrator from Epic 4
  - [ ] Override deployment workflow

- [ ] Task 2: Integrate ALB in Deployment Flow (AC: 2)
  - [ ] Add ALB creation step after EC2
  - [ ] Pass VPC and subnet info to ALB service
  - [ ] Create target groups before ALB

- [ ] Task 3: Register Instances with Target Groups (AC: 3)
  - [ ] Get EC2 instance IDs after creation
  - [ ] Register each instance with appropriate target group
  - [ ] Handle multiple services per instance

- [ ] Task 4: Wait for Healthy Targets (AC: 4)
  - [ ] Poll target health status
  - [ ] Wait until all targets healthy
  - [ ] Configurable timeout
  - [ ] Report unhealthy targets

- [ ] Task 5: Handle ALB Creation Failures (AC: 5)
  - [ ] Catch ALB creation errors
  - [ ] Provide meaningful error messages
  - [ ] Include AWS error details
  - [ ] Suggest remediation steps

- [ ] Task 6: Implement ALB Rollback (AC: 6)
  - [ ] Delete listener rules
  - [ ] Delete listeners
  - [ ] Delete target groups
  - [ ] Delete ALB
  - [ ] Deregister targets first

- [ ] Task 7: Report ALB Progress (AC: 7)
  - [ ] Show "Creating ALB..." status
  - [ ] Show "Creating target groups..."
  - [ ] Show "Registering instances..."
  - [ ] Show "Waiting for healthy targets..."
  - [ ] Show final ALB DNS name

- [ ] Task 8: Create Unit Tests (AC: 8)
  - [ ] Test orchestrator initialization
  - [ ] Test deployment workflow
  - [ ] Test instance registration
  - [ ] Test health check waiting
  - [ ] Test rollback
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Architecture References
- See `docs/architecture/ARCHITECTURE.md` for orchestrator patterns
- Tier 2 orchestrator inherits from Tier 1 orchestrator
- Uses composition for ALB service

### Deployment Sequence
```
1. VPC/Subnet selection (inherited)
2. Security Group creation (inherited)
3. EFS creation (inherited)
4. EC2 instance launch (inherited)
5. ALB creation (new)
6. Target group creation (new)
7. Instance registration (new)
8. Wait for healthy targets (new)
9. Return deployment state (updated)
```

### Error Recovery
- ALB failures don't require EC2 rollback
- Can retry ALB creation with existing EC2
- Target registration can be retried

### Configuration
```python
ALB_CONFIG = {
    "wait_timeout": 300,  # 5 minutes
    "health_check_interval": 30,
    "healthy_threshold": 2,
    "unhealthy_threshold": 3
}
```

## Testing

### Unit Tests
- Mock ALB service
- Test deployment workflow integration
- Test instance registration
- Test health check polling
- Test rollback procedures

### Integration Tests
- Full Tier 2 deployment
- Verify ALB serves traffic
- Test failure and rollback
- Test partial deployment recovery

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
