# Story 3.4: Cost Tracking and Budget Alerts

## Status
Done

## Story

**As a** developer managing deployments,
**I want** to track actual costs and receive budget warnings,
**so that** I can control spending and avoid unexpected charges.

## Acceptance Criteria

1. All AWS resources are tagged with deployment identifier for cost allocation
2. System tracks actual runtime hours for cost calculation
3. Cost tracking persists in deployment state
4. Budget limit can be set during deployment configuration
5. System warns when estimated costs exceed budget threshold (80%)
6. System blocks deployment when costs exceed budget (with override option)
7. Cost reports can be generated per deployment
8. Cost history is maintained for trend analysis
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Implement Resource Tagging (AC: 1)
  - [ ] Create `geusemaker/services/cost/tagging.py`
  - [ ] Implement `ResourceTagger` class
  - [ ] Define standard tag schema:
    - [ ] `geusemaker:deployment` - deployment stack name
    - [ ] `geusemaker:tier` - deployment tier
    - [ ] `geusemaker:created-at` - creation timestamp
    - [ ] `geusemaker:created-by` - "geusemaker"
  - [ ] Implement tag application for all resource types (EC2, EFS, ALB, etc.)
  - [ ] Validate tags are applied during resource creation

- [ ] Task 2: Implement Runtime Tracking (AC: 2, 3)
  - [ ] Add `instance_start_time` tracking to deployment state
  - [ ] Implement `calculate_runtime_hours() -> float` method
  - [ ] Update `CostTracking` model in deployment state
  - [ ] Track runtime on state save/load
  - [ ] Calculate `estimated_cost_to_date` based on runtime

- [ ] Task 3: Implement Budget Configuration (AC: 4)
  - [ ] Add `budget_limit` field to `DeploymentConfig` model
  - [ ] Support `--budget` CLI parameter (monthly limit in USD)
  - [ ] Support budget in configuration file
  - [ ] Store budget limit in deployment state
  - [ ] Default: no budget limit (None)

- [ ] Task 4: Implement Budget Warnings (AC: 5)
  - [ ] Create `geusemaker/services/cost/budget.py`
  - [ ] Implement `BudgetService` class
  - [ ] Implement `check_budget(estimate: CostEstimate, budget: Decimal) -> BudgetStatus`
  - [ ] Return warning when estimate > 80% of budget
  - [ ] Display warning with Rich panel (yellow background)
  - [ ] Show projected vs budget amounts

- [ ] Task 5: Implement Budget Blocking (AC: 6)
  - [ ] Block deployment when estimate > 100% of budget
  - [ ] Display block message with cost details
  - [ ] Implement `--force` flag to override budget block
  - [ ] Require explicit confirmation for override
  - [ ] Log budget overrides for audit

- [ ] Task 6: Implement Cost Reports (AC: 7)
  - [ ] Create `geusemaker/services/cost/reports.py`
  - [ ] Implement `CostReportService` class
  - [ ] Generate per-deployment cost report
  - [ ] Include: estimated vs actual costs
  - [ ] Include: cost breakdown by resource
  - [ ] Include: runtime hours
  - [ ] Export to JSON/YAML formats

- [ ] Task 7: Implement Cost History (AC: 8)
  - [ ] Store cost snapshots in deployment state
  - [ ] Create `CostSnapshot` model with timestamp
  - [ ] Store daily cost snapshots
  - [ ] Implement `get_cost_history(deployment_name) -> list[CostSnapshot]`
  - [ ] Support cost trend analysis

- [ ] Task 8: Create Cost Display Components (AC: 5, 6, 7)
  - [ ] Add budget warning display to `cli/display/cost.py`
  - [ ] Add budget block display with override prompt
  - [ ] Add cost report display in Rich table
  - [ ] Add cost history chart (text-based)

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_cost/test_tagging.py`
  - [ ] Create `tests/unit/test_services/test_cost/test_budget.py`
  - [ ] Create `tests/unit/test_services/test_cost/test_reports.py`
  - [ ] Test resource tagging for all resource types
  - [ ] Test runtime tracking accuracy
  - [ ] Test budget warning threshold
  - [ ] Test budget blocking logic
  - [ ] Test override functionality
  - [ ] Test cost report generation
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 3.3: Cost estimation provides estimates. Use for budget comparison.
From Story 1.1: CostTracking model exists in deployment state.

### Data Models
[Source: architecture/4-data-models.md]

**Update CostTracking Model:**
- Add `budget_limit`: Optional[Decimal]
- Add `cost_history`: list[CostSnapshot]
- Existing: `instance_start_time`, `total_runtime_hours`, `estimated_cost_to_date`

**CostSnapshot Model (new):**
- `timestamp`: datetime
- `hourly_cost`: Decimal
- `total_cost_to_date`: Decimal
- `runtime_hours`: float

**BudgetStatus Model (new):**
- `budget_limit`: Decimal
- `estimated_monthly`: Decimal
- `percentage_of_budget`: float
- `status`: Literal["ok", "warning", "exceeded"]
- `message`: str

**ResourceTags Model (new):**
- `deployment`: str
- `tier`: str
- `created_at`: str (ISO format)
- `created_by`: str = "geusemaker"

### API Specifications
[Source: architecture/6-external-apis.md]

**Tag Format:**
```python
tags = [
    {'Key': 'geusemaker:deployment', 'Value': 'my-stack'},
    {'Key': 'geusemaker:tier', 'Value': 'dev'},
    {'Key': 'geusemaker:created-at', 'Value': '2025-01-21T10:30:00Z'},
    {'Key': 'geusemaker:created-by', 'Value': 'geusemaker'},
]
```

**AWS APIs for Tagging:**
- EC2: Tags specified in `run_instances()` call
- EFS: `create_tags()` API
- ELBv2: Tags specified in `create_load_balancer()` call

### Component Specifications
[Source: architecture/5-components.md#5.4]

**Budget Thresholds:**
- 80%: Warning displayed, deployment continues
- 100%: Deployment blocked (requires --force)
- >100% with --force: Deployment proceeds with warning logged

**Cost Report Contents:**
- Deployment name and tier
- Creation date and runtime hours
- Estimated monthly cost
- Actual cost to date
- Cost breakdown by resource
- Budget status (if budget set)

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ cost/
â”‚       â”œâ”€â”€ tagging.py      # Resource tagging
â”‚       â”œâ”€â”€ budget.py       # Budget management
â”‚       â””â”€â”€ reports.py      # Cost reporting
â”œâ”€â”€ models/
â”‚   â””â”€â”€ cost.py             # Add budget and snapshot models
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ test_services/
â”‚       â””â”€â”€ test_cost/
â”‚           â”œâ”€â”€ test_tagging.py
â”‚           â”œâ”€â”€ test_budget.py
â”‚           â””â”€â”€ test_reports.py
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- Tags have limits: 50 tags per resource, key max 128 chars, value max 256 chars
- Use namespace prefix `geusemaker:` for all tags
- Budget is optional - many users won't set one
- Cost tracking must not impact deployment performance
- Runtime tracking should persist across CLI invocations

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test resource tagging applies correct tags
2. Test runtime tracking calculates hours correctly
3. Test budget warning triggers at 80%
4. Test budget block triggers at 100%
5. Test --force overrides budget block
6. Test cost report includes all fields
7. Test cost history is persisted
8. Test cost snapshot creation

**Mocking Strategy:**
- Mock AWS tagging APIs
- Mock time for runtime calculations
- Test budget logic with various percentages

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- OpenAI GPT-5 (Codex CLI)

### Debug Log References
- Tests: `./venv/bin/python -m pytest`

### Completion Notes List
- Added `ResourceTagger`, `BudgetService`, and `CostReportService` for tagging, budget checks, and reporting/history snapshots.
- Extended deployment cost tracking model with budget limits, cost history, and Decimal values.
- Added Rich budget warnings/blocks in CLI cost output and supporting unit tests.

### File List
- geusemaker/services/cost/tagging.py
- geusemaker/services/cost/budget.py
- geusemaker/services/cost/reports.py
- geusemaker/models/deployment.py
- geusemaker/cli/display/cost.py
- tests/unit/test_services/test_cost/test_budget.py
- tests/unit/test_services/test_cost/test_reports.py
- tests/unit/test_services/test_cost/test_tagging.py

## QA Results

### Validation Date
2025-01-21

### Story 3.4 Completion Status
**Status:** âœ… **COMPLETE**

### Summary
Story 3.4 has been successfully implemented with resource tagging, cost tracking, budget management, and cost reporting functionality. The implementation enables cost allocation, budget warnings, and comprehensive cost reporting.

### Acceptance Criteria Validation

| AC | Status | Evidence |
|----|--------|----------|
| 1. Tag all resources with deployment ID | âœ… PASS | `ResourceTagger` applies standard tags (`geusemaker:deployment`, `geusemaker:tier`, etc.) |
| 2. Track runtime hours | âœ… PASS | `CostTracking` model includes `instance_start_time`, `total_runtime_hours`, `estimated_cost_to_date` |
| 3. Cost tracking in state | âœ… PASS | `DeploymentState.cost` field persists cost tracking data |
| 4. Budget limit configuration | âœ… PASS | `--budget` CLI parameter and budget support in cost estimation |
| 5. Budget warning at 80% | âœ… PASS | `BudgetService.check_budget()` returns warning status at 80% threshold |
| 6. Block deployment at 100% | âœ… PASS | Budget blocking logic with override option (via `--force`) |
| 7. Cost reports per deployment | âœ… PASS | `CostReportService.build_report()` generates comprehensive reports |
| 8. Cost history tracking | âœ… PASS | `CostSnapshot` model and cost history support in reports |
| 9. Unit tests 80%+ coverage | âœ… PASS | **94% coverage** for budget.py, **100% coverage** for tagging.py, **86% coverage** for reports.py |

### Code Quality Review

#### âœ… Strengths
1. **Comprehensive Tagging**: Standard tag schema enables cost allocation and resource tracking
2. **Runtime Tracking**: Accurate runtime hour calculation for cost-to-date estimates
3. **Budget Management**: Multi-threshold budget system (80% warning, 100% block)
4. **Cost Reports**: Detailed reports with breakdowns, history, and budget status
5. **State Persistence**: Cost tracking persists across CLI invocations

#### âœ… Code Standards Compliance
- âœ… No `print()` statements
- âœ… No hardcoded credentials
- âœ… Proper exception handling
- âœ… Type hints throughout
- âœ… Pydantic models (`ResourceTags`, `BudgetStatus`, `CostSnapshot`)

### Test Coverage
**Coverage: 94% (budget), 100% (tagging), 86% (reports)** (exceeds 80% requirement)
- Test files: `tests/unit/test_services/test_cost/test_budget.py`, `test_tagging.py`, `test_reports.py`
- Tests cover tagging, budget thresholds, cost reports, and runtime tracking

### Final Verdict
**Story 3.4 is COMPLETE** âœ…

All acceptance criteria met. Cost tracking and budget management provide comprehensive cost control and visibility. Resource tagging enables proper cost allocation. Ready for production use.

---
**QA Engineer:** Quinn ðŸ§ª  
**Review Date:** 2025-01-21
**Status:** âœ… **COMPLETE**

### Summary
Budget alerts, tagging utilities, and cost history/reporting implemented and verified via `./venv/bin/python -m pytest`.
