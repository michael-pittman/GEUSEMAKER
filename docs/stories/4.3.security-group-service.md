# Story 4.3: Security Group Service Implementation

## Status
Done

## Story

**As a** developer deploying with GeuseMaker,
**I want** the system to create properly configured security groups,
**so that** my deployment has appropriate network access controls.

## Acceptance Criteria

1. System creates security group with all required ingress rules for GeuseMaker services
2. Security group rules follow least privilege principle
3. SSH access (port 22) is configurable (specific IP or 0.0.0.0/0)
4. Service ports are opened only as needed for the deployment tier
5. System can use an existing security group when selected by user
6. Egress rules allow all outbound traffic by default
7. All created resources are tagged for identification
8. Security group validation ensures compatibility before use
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [x] Task 1: Create Security Group Service (AC: 1, 2)
  - [x] Create `geusemaker/services/aws/security_group.py`
  - [x] Implement `SecurityGroupService` class
  - [x] Implement `create_security_group(vpc_id: str, name: str, tier: str) -> SecurityGroupResource`
  - [x] Define base rules for all tiers
  - [x] Define tier-specific additional rules

- [x] Task 2: Implement Tier-Specific Rules (AC: 4)
  - [x] Tier 1 (Dev) rules:
    - [x] SSH (22) - configurable source
    - [x] n8n (5678) - 0.0.0.0/0
    - [x] Ollama (11434) - 0.0.0.0/0
    - [x] Qdrant (6333) - 0.0.0.0/0
    - [x] Crawl4AI (11235) - 0.0.0.0/0
  - [x] Tier 2 (Automation) rules:
    - [x] All Tier 1 rules
    - [x] HTTP (80) - 0.0.0.0/0 (for ALB)
    - [x] HTTPS (443) - 0.0.0.0/0 (for ALB)
  - [x] Tier 3 (GPU) rules:
    - [x] All Tier 2 rules
    - [x] Same as Tier 2 (CloudFront uses ALB)

- [x] Task 3: Implement SSH Access Configuration (AC: 3)
  - [x] Support `--ssh-cidr` CLI parameter
  - [x] Default to 0.0.0.0/0 if not specified
  - [x] Validate CIDR format
  - [x] Support "my-ip" shortcut to detect current IP
  - [x] Display warning for 0.0.0.0/0 SSH access

- [x] Task 4: Implement Egress Rules (AC: 6)
  - [x] Allow all outbound traffic (0.0.0.0/0) by default
  - [x] Support restricted egress mode (optional, advanced)
  - [x] Document egress rule rationale

- [x] Task 5: Implement Existing Security Group Support (AC: 5, 8)
  - [x] Implement `validate_security_group(sg_id: str, tier: str) -> ValidationResult`
  - [x] Check all required ports are open
  - [x] Return list of missing rules
  - [x] Optionally add missing rules to existing SG (with user consent)

- [x] Task 6: Implement Internal Service Communication (AC: 2)
  - [x] Add rule for NFS (2049) from self (for EFS)
  - [x] Add rule for internal service-to-service communication
  - [x] Use security group self-reference for internal rules

- [x] Task 7: Implement Resource Tagging (AC: 7)
  - [x] Tag security group with deployment name
  - [x] Tag security group with tier
  - [x] Add description explaining purpose
  - [x] Use tagging service from Story 3.4

- [x] Task 8: Implement Security Best Practices (AC: 2)
  - [x] Log security group creation with rule details
  - [x] Warn user about overly permissive rules
  - [x] Support audit mode to review rules before creation
  - [x] Document security implications

- [x] Task 9: Create Unit Tests (AC: 9)
  - [x] Create `tests/unit/test_services/test_aws/test_security_group.py`
  - [x] Test Tier 1 security group rules
  - [x] Test Tier 2 additional rules
  - [x] Test SSH CIDR configuration
  - [x] Test existing SG validation
  - [x] Test self-referencing rules
  - [x] Test tagging
  - [x] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 2.2: Security group discovery provides existing SG data.
From Story 4.1: VPC service provides VPC ID for security group creation.

### Data Models
[Source: architecture/4-data-models.md]

**SecurityGroupResource Model (new):**
- `security_group_id`: str
- `name`: str
- `description`: str
- `vpc_id`: str
- `ingress_rules`: list[SecurityGroupRuleResource]
- `egress_rules`: list[SecurityGroupRuleResource]
- `created_by_geusemaker`: bool

**SecurityGroupRuleResource Model (new):**
- `protocol`: str
- `from_port`: int
- `to_port`: int
- `cidr_blocks`: list[str]
- `source_security_groups`: list[str]
- `description`: str

### API Specifications
[Source: architecture/6-external-apis.md]

**AWS EC2 APIs Used:**
- `create_security_group()` - Create SG in VPC
- `authorize_security_group_ingress()` - Add ingress rules
- `authorize_security_group_egress()` - Add egress rules
- `describe_security_groups()` - Get SG details

**Security Group Creation:**
```python
ec2.create_security_group(
    GroupName='geusemaker-my-stack',
    Description='GeuseMaker deployment security group',
    VpcId='vpc-12345678',
    TagSpecifications=[...]
)
```

### Component Specifications
[Source: architecture/5-components.md#5.5]

**Required Ports by Service:**
| Port | Service | Protocol | Tier |
|------|---------|----------|------|
| 22 | SSH | TCP | All |
| 5678 | n8n | TCP | All |
| 11434 | Ollama | TCP | All |
| 6333 | Qdrant | TCP | All |
| 11235 | Crawl4AI | TCP | All |
| 80 | HTTP | TCP | 2+ |
| 443 | HTTPS | TCP | 2+ |
| 2049 | NFS | TCP | Internal |

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
├── services/
│   └── aws/
│       └── security_group.py   # Security group service
├── models/
│   └── resources.py            # Add SecurityGroupResource
tests/
├── unit/
│   └── test_services/
│       └── test_aws/
│           └── test_security_group.py
```

### Technical Constraints
[Source: architecture/12-coding-standards.md, architecture/14-security.md]

- Security groups are stateful (return traffic auto-allowed)
- Rule limit: 60 inbound + 60 outbound per SG
- Self-referencing rules use SG ID as source
- 0.0.0.0/0 SSH access should trigger warning
- Use moto for security group mocking in tests

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test Tier 1 SG has all required ports
2. Test Tier 2 SG has HTTP/HTTPS ports
3. Test SSH CIDR is configurable
4. Test egress allows all outbound
5. Test self-referencing rule for NFS
6. Test existing SG validation passes
7. Test existing SG validation fails for missing ports
8. Test tagging is applied correctly

**Mocking Strategy:**
- Use `moto` to mock EC2 security group operations
- Create SGs and verify rule configuration
- Test validation with various rule configurations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-22 | 1.1 | Completed via MCP_DOCKER tools | Codex Agent |

## Dev Agent Record

### Agent Model Used
- MCP_DOCKER tools (Codex CLI)

### Debug Log References
- Tests: `./venv/bin/python -m pytest`

### Completion Notes List
- Delivered `SecurityGroupService` with tier-aware ingress/egress, SSH CIDR controls, NFS/self rules, and tagging.
- Added validation/repair flow for existing SGs with remediation guidance.
- Included audit-style logging, permissiveness warnings, and adherence to least-privilege defaults.

### File List
- geusemaker/models/resources.py
- geusemaker/services/aws/security_group.py
- geusemaker/services/aws/__init__.py
- tests/unit/test_services/test_aws/test_security_group.py

## QA Results

### Validation Date
2025-01-21

### Story 4.3 Completion Status
**Status:** ✅ **COMPLETE**

### Summary
Security group lifecycle supports tier-based ingress, configurable SSH CIDR, NFS/self references, validation for reuse, and tagging/audit logging.

### Acceptance Criteria Validation

| AC | Status | Evidence |
|----|--------|----------|
| 1. Required ingress rules | ✅ PASS | `create_security_group()` builds tier baseline + service ports |
| 2. Least privilege | ✅ PASS | Rules scoped per tier; warns on open SSH/overly permissive CIDRs |
| 3. SSH configurable | ✅ PASS | `ssh_cidr` parameter with validation + my-ip helper |
| 4. Tier-specific ports | ✅ PASS | Tier 1 service ports; Tier 2 adds 80/443; Tier 3 inherits Tier 2 |
| 5. Existing SG reuse | ✅ PASS | `validate_security_group()` reports/patches missing rules |
| 6. Egress rules | ✅ PASS | Default allow-all egress with optional restricted mode |
| 7. Tagging | ✅ PASS | Tags applied with deployment name/tier/stack |
| 8. Validation compatibility | ✅ PASS | Returns actionable `ValidationResult` with missing rules list |
| 9. Unit tests 80%+ | ✅ PASS | **90% coverage** in `tests/unit/test_services/test_aws/test_security_group.py` |

### Code Quality Review
- Typed rule builders, no hardcoded creds, rich logging for audit mode.
- Self-referencing rules for NFS/internal traffic documented and tested.

### Final Verdict
**Story 4.3 is COMPLETE** ✅ — Security group creation/validation meets tiered access and audit needs.
