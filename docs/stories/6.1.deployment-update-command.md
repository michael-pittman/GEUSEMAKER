# Story 6.1: Deployment Update Command

## Status
Done

## Story

**As a** developer managing a running deployment,
**I want** to update deployment configurations without destroying resources,
**so that** I can scale, reconfigure, or update services while preserving data.

## Acceptance Criteria

1. `geusemaker update <name>` updates an existing deployment
2. Update supports instance type changes (requires instance restart)
3. Update supports scaling (future: multiple instances)
4. Update supports container image version updates
5. Update preserves EFS data during all update operations
6. Update validates changes before applying
7. Update displays progress and confirms changes
8. Update saves previous state for rollback capability
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Update Command (AC: 1)
  - [ ] Create `geusemaker/cli/commands/update.py`
  - [ ] Implement `update` Click command
  - [ ] Load existing deployment state
  - [ ] Accept update parameters via CLI flags
  - [ ] Handle deployment not found

- [ ] Task 2: Implement Instance Type Update (AC: 2)
  - [ ] Create `geusemaker/services/update/instance.py`
  - [ ] Implement `update_instance_type(deployment, new_type) -> UpdateResult`
  - [ ] Stop existing instance
  - [ ] Modify instance type
  - [ ] Start instance
  - [ ] Update deployment state

- [ ] Task 3: Implement Container Image Update (AC: 4)
  - [ ] Create `geusemaker/services/update/containers.py`
  - [ ] Implement `update_container_images(deployment, images: dict) -> UpdateResult`
  - [ ] SSH/SSM to instance
  - [ ] Update docker-compose.yml with new image tags
  - [ ] Pull new images
  - [ ] Restart containers

- [ ] Task 4: Implement Data Preservation (AC: 5)
  - [ ] Verify EFS volumes are mounted before update
  - [ ] Ensure container volumes point to EFS
  - [ ] Validate data integrity after update
  - [ ] Document which data is preserved

- [ ] Task 5: Implement Pre-Update Validation (AC: 6)
  - [ ] Validate new instance type is valid
  - [ ] Validate new instance type has capacity
  - [ ] Validate new images exist (docker pull dry-run)
  - [ ] Show validation results before proceeding

- [ ] Task 6: Implement Update Progress Display (AC: 7)
  - [ ] Show current vs new configuration
  - [ ] Request confirmation before applying
  - [ ] Show progress during update
  - [ ] Show completion status

- [ ] Task 7: Implement State Backup (AC: 8)
  - [ ] Save current state as "last_healthy_state"
  - [ ] Store rollback information
  - [ ] Update state with new configuration
  - [ ] Link update to rollback record

- [ ] Task 8: Create Update Service (AC: 1, 2, 4)
  - [ ] Create `geusemaker/services/update/__init__.py`
  - [ ] Create `geusemaker/services/update/orchestrator.py`
  - [ ] Implement `UpdateOrchestrator` class
  - [ ] Coordinate all update operations
  - [ ] Handle partial updates

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_update/test_orchestrator.py`
  - [ ] Test instance type update flow
  - [ ] Test container image update
  - [ ] Test pre-update validation
  - [ ] Test state backup creation
  - [ ] Test error handling
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 4.6: Orchestrator provides deployment creation patterns.
From Story 4.8: Inspect command shows current deployment state.

### Data Models
[Source: architecture/4-data-models.md]

**UpdateRequest Model (new):**
- `deployment_name`: str
- `instance_type`: Optional[str]
- `container_images`: Optional[dict[str, str]]
- `force`: bool = False

**UpdateResult Model (new):**
- `success`: bool
- `changes_applied`: list[str]
- `previous_state`: dict
- `new_state`: dict
- `duration_seconds`: float
- `warnings`: list[str]

### CLI Specifications
[Source: architecture/5-components.md#5.1]

**Update Command Usage:**
```bash
# Update instance type
geusemaker update my-dev-stack --instance-type t3.large

# Update container images
geusemaker update my-dev-stack --image n8n=n8nio/n8n:1.20.0

# Multiple updates
geusemaker update my-dev-stack --instance-type t3.large --image ollama=ollama/ollama:0.2.0

# Force update without confirmation
geusemaker update my-dev-stack --instance-type t3.large --force
```

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
├── services/
│   └── update/
│       ├── __init__.py
│       ├── orchestrator.py  # Update orchestration
│       ├── instance.py      # Instance updates
│       └── containers.py    # Container updates
├── cli/
│   └── commands/
│       └── update.py        # Update command
tests/
├── unit/
│   └── test_services/
│       └── test_update/
│           └── test_orchestrator.py
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- Instance type change requires instance stop/start
- Container updates require SSH/SSM access to instance
- EFS data is preserved across instance restarts
- Some updates may cause brief service downtime

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test instance type update stops and starts instance
2. Test container image update pulls new images
3. Test validation catches invalid instance types
4. Test state backup is created before update
5. Test data is preserved during updates
6. Test confirmation is required (unless --force)

**Mocking Strategy:**
- Mock EC2 stop/start/modify APIs
- Mock SSH/SSM command execution
- Test update orchestration flow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results

**Reviewed by:** Quinn (QA Agent)  
**Review Date:** 2025-01-21  
**Status:** ✅ **APPROVED WITH RECOMMENDATIONS**

### Strengths
- ✅ Comprehensive task breakdown covering all update scenarios
- ✅ Clear acceptance criteria with measurable outcomes
- ✅ Strong focus on data preservation (EFS)
- ✅ State backup for rollback capability
- ✅ Good test coverage requirements (80%+)

### Issues Identified

1. **⚠️ AC #3 - Scaling Scope Ambiguity**
   - **Issue**: "Update supports scaling (future: multiple instances)" is vague
   - **Impact**: Unclear if multi-instance scaling is in-scope or deferred
   - **Recommendation**: Clarify scope:
     - Option A: Remove "(future: multiple instances)" and mark as deferred to future story
     - Option B: Add explicit task for multi-instance scaling if in-scope
   - **Priority**: Medium

2. **⚠️ Missing PRD Coverage**
   - **Issue**: PRD 6.5 requires "Rotate credentials" and "Apply security patches" - not covered
   - **Impact**: Epic 6 will not fully satisfy PRD requirements
   - **Recommendation**: Story 6.5 created to address these gaps
   - **Priority**: High (addressed via Story 6.5)

3. **⚠️ Task 2 - Downtime Impact**
   - **Issue**: Instance type update requires stop/start but doesn't mention downtime
   - **Impact**: Users may not understand service interruption
   - **Recommendation**: Add subtask to document expected downtime duration
   - **Priority**: Low

4. **ℹ️ Task 8 - Partial Updates**
   - **Issue**: "Handle partial updates" mentioned but not detailed
   - **Impact**: Unclear what partial update scenarios are supported
   - **Recommendation**: Add subtasks specifying partial update scenarios (e.g., instance only, containers only)
   - **Priority**: Low

### Dependency Validation
- ✅ Epic 4 dependency correctly identified
- ✅ Story 4.6 and 4.8 references are appropriate

### Test Coverage Assessment
- ✅ Test cases cover all major update scenarios
- ✅ Mocking strategy is appropriate
- ⚠️ Consider adding integration tests for end-to-end update flow

### Overall Assessment
Story is well-structured and technically sound. Main gap (credential rotation/security patches) addressed via Story 6.5. AC #3 should be clarified before implementation.
