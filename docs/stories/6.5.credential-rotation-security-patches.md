# Story 6.5: Credential Rotation and Security Patches

## Status
Draft

## Story

**As a** security-conscious developer managing production deployments,
**I want** to rotate credentials and apply security patches to running deployments,
**so that** I can maintain security compliance and protect against vulnerabilities without redeploying.

## Acceptance Criteria

1. `geusemaker update <name> --rotate-credentials` rotates all service credentials
2. Credential rotation updates n8n admin credentials
3. Credential rotation updates PostgreSQL database passwords
4. Credential rotation updates service API keys/tokens (if applicable)
5. Credential rotation preserves EFS data and service configurations
6. `geusemaker update <name> --security-patch` applies security patches
7. Security patches update container images to latest security-patched versions
8. Security patches validate patch compatibility before applying
9. Security patches preserve data and configurations
10. Both operations save state for rollback capability
11. Both operations display progress and confirm changes
12. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Extend Update Command for Credential Rotation (AC: 1)
  - [ ] Add `--rotate-credentials` flag to update command
  - [ ] Add `--security-patch` flag to update command
  - [ ] Validate deployment exists and is running
  - [ ] Show confirmation with affected services
  - [ ] Handle deployment not found or stopped

- [ ] Task 2: Create Credential Rotation Service (AC: 2, 3, 4)
  - [ ] Create `geusemaker/services/update/credentials.py`
  - [ ] Implement `CredentialRotationService` class
  - [ ] Implement `rotate_credentials(deployment) -> RotationResult`
  - [ ] Generate secure random passwords (min 32 chars, alphanumeric + special)
  - [ ] Store credentials securely (encrypted in state or AWS Secrets Manager)

- [ ] Task 3: Implement n8n Credential Rotation (AC: 2)
  - [ ] SSH/SSM to instance
  - [ ] Generate new admin password
  - [ ] Update n8n environment variables (N8N_BASIC_AUTH_USER, N8N_BASIC_AUTH_PASSWORD)
  - [ ] Update docker-compose.yml with new credentials
  - [ ] Restart n8n container
  - [ ] Verify n8n is accessible with new credentials
  - [ ] Update deployment state with new credentials (encrypted)

- [ ] Task 4: Implement PostgreSQL Credential Rotation (AC: 3)
  - [ ] SSH/SSM to instance
  - [ ] Generate new PostgreSQL password
  - [ ] Update PostgreSQL password via psql
  - [ ] Update docker-compose.yml with new POSTGRES_PASSWORD
  - [ ] Update n8n database connection string
  - [ ] Restart PostgreSQL and n8n containers
  - [ ] Verify database connectivity
  - [ ] Update deployment state with new password (encrypted)

- [ ] Task 5: Implement Service API Key Rotation (AC: 4)
  - [ ] Identify services with API keys/tokens
  - [ ] Generate new API keys where applicable
  - [ ] Update service configurations
  - [ ] Restart affected services
  - [ ] Verify services are accessible
  - [ ] Document which services support key rotation

- [ ] Task 6: Implement Data Preservation During Rotation (AC: 5)
  - [ ] Verify EFS volumes are mounted before rotation
  - [ ] Ensure credential changes don't affect data volumes
  - [ ] Validate service connectivity after rotation
  - [ ] Document credential rotation impact on data access

- [ ] Task 7: Create Security Patch Service (AC: 6, 7)
  - [ ] Create `geusemaker/services/update/security.py`
  - [ ] Implement `SecurityPatchService` class
  - [ ] Implement `apply_security_patches(deployment) -> PatchResult`
  - [ ] Query container registries for security-patched versions
  - [ ] Identify services with available security patches

- [ ] Task 8: Implement Security Patch Application (AC: 7, 8)
  - [ ] SSH/SSM to instance
  - [ ] Check current container image versions
  - [ ] Query for latest security-patched versions (same major.minor, patch level)
  - [ ] Validate patch compatibility (no breaking changes)
  - [ ] Update docker-compose.yml with patched image versions
  - [ ] Pull new images
  - [ ] Restart containers with patched images
  - [ ] Verify services are healthy after patch

- [ ] Task 9: Implement Patch Compatibility Validation (AC: 8)
  - [ ] Check image version compatibility (semantic versioning)
  - [ ] Validate patch doesn't require configuration changes
  - [ ] Test patch on staging/test environment (if available)
  - [ ] Show validation results before applying
  - [ ] Allow user to skip incompatible patches

- [ ] Task 10: Implement State Backup for Both Operations (AC: 10)
  - [ ] Save current state as "pre_rotation_state" or "pre_patch_state"
  - [ ] Store rollback information with credential/patch details
  - [ ] Update state with new credentials (encrypted) or image versions
  - [ ] Link operation to rollback record

- [ ] Task 11: Implement Progress Display (AC: 11)
  - [ ] Show current vs new credentials (masked) or image versions
  - [ ] Request confirmation before applying
  - [ ] Show progress during rotation/patch
  - [ ] Show completion status with summary
  - [ ] Display new credentials securely (one-time display, encrypted storage)

- [ ] Task 12: Create Unit Tests (AC: 12)
  - [ ] Create `tests/unit/test_services/test_update/test_credentials.py`
  - [ ] Create `tests/unit/test_services/test_update/test_security.py`
  - [ ] Test credential rotation flow
  - [ ] Test n8n credential update
  - [ ] Test PostgreSQL password rotation
  - [ ] Test security patch detection and application
  - [ ] Test patch compatibility validation
  - [ ] Test state backup creation
  - [ ] Test error handling
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 6.1: Update command provides base infrastructure for deployment updates.
From Story 6.2: Rollback capability enables safe credential/patch operations.

### Data Models
[Source: architecture/4-data-models.md]

**CredentialRotationRequest Model (new):**
- `deployment_name`: str
- `rotate_n8n`: bool = True
- `rotate_postgres`: bool = True
- `rotate_api_keys`: bool = False
- `force`: bool = False

**CredentialRotationResult Model (new):**
- `success`: bool
- `credentials_rotated`: list[str]  # Service names
- `new_credentials`: dict[str, str]  # Encrypted credentials
- `previous_state`: dict
- `duration_seconds`: float
- `warnings`: list[str]

**SecurityPatchRequest Model (new):**
- `deployment_name`: str
- `services`: Optional[list[str]]  # Specific services, or all if None
- `dry_run`: bool = False
- `force`: bool = False

**SecurityPatchResult Model (new):**
- `success`: bool
- `patches_applied`: list[PatchInfo]
- `patches_skipped`: list[PatchInfo]
- `previous_state`: dict
- `duration_seconds`: float
- `warnings`: list[str]

**PatchInfo Model (new):**
- `service_name`: str
- `old_version`: str
- `new_version`: str
- `patch_level`: str  # e.g., "security", "bugfix"
- `cve_ids`: list[str]  # CVE numbers addressed

### CLI Specifications
[Source: architecture/5-components.md#5.1]

**Credential Rotation Command Usage:**
```bash
# Rotate all credentials
geusemaker update my-dev-stack --rotate-credentials

# Rotate specific service credentials
geusemaker update my-dev-stack --rotate-credentials --services n8n,postgres

# Force rotation without confirmation
geusemaker update my-dev-stack --rotate-credentials --force
```

**Security Patch Command Usage:**
```bash
# Apply security patches to all services
geusemaker update my-dev-stack --security-patch

# Apply patches to specific services
geusemaker update my-dev-stack --security-patch --services n8n,ollama

# Dry run (show what would be patched)
geusemaker update my-dev-stack --security-patch --dry-run

# Force patch without confirmation
geusemaker update my-dev-stack --security-patch --force
```

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
├── services/
│   └── update/
│       ├── __init__.py
│       ├── orchestrator.py      # Existing update orchestration
│       ├── instance.py           # Existing instance updates
│       ├── containers.py         # Existing container updates
│       ├── credentials.py       # NEW: Credential rotation
│       └── security.py           # NEW: Security patches
├── cli/
│   └── commands/
│       └── update.py             # Extend existing update command
tests/
├── unit/
│   └── test_services/
│       └── test_update/
│           ├── test_orchestrator.py  # Existing
│           ├── test_credentials.py   # NEW
│           └── test_security.py      # NEW
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- Credential rotation requires SSH/SSM access to instance
- Security patches require container registry access
- Credentials must be encrypted in state files (never plaintext)
- Consider AWS Secrets Manager for production credential storage
- Security patches should only update patch versions (not minor/major)
- Patch compatibility validation prevents breaking changes
- Credential rotation may cause brief service downtime
- Both operations should be idempotent (safe to re-run)

### Security Considerations

- **Credential Storage**: Use encryption at rest for credentials in state files
- **Credential Transmission**: Use secure channels (SSH/SSM) for credential updates
- **Credential Display**: Show credentials only once, mask in logs
- **Patch Validation**: Verify patch sources and signatures
- **Audit Trail**: Log all credential rotations and security patches
- **Access Control**: Consider IAM roles for credential rotation operations

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test credential rotation updates n8n credentials
2. Test credential rotation updates PostgreSQL password
3. Test credential rotation preserves data
4. Test security patch detection finds available patches
5. Test security patch application updates images
6. Test patch compatibility validation rejects incompatible patches
7. Test state backup is created before rotation/patch
8. Test rollback works after credential rotation
9. Test rollback works after security patch
10. Test confirmation is required (unless --force)
11. Test credentials are encrypted in state

**Mocking Strategy:**
- Mock SSH/SSM command execution
- Mock container registry queries
- Mock credential generation
- Test rotation and patch orchestration flows
- Mock encryption/decryption for credential storage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation to address PRD gaps | Quinn (QA Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_















