# Story 7.2: State Migration and Versioning

## Status
Done

## Story

**As a** developer upgrading GeuseMaker,
**I want** automatic state migration between versions,
**so that** my existing deployments remain compatible after upgrades.

## Acceptance Criteria

1. State files include version number for tracking
2. Migration detects when state version differs from current
3. Migrations run automatically on state load
4. Migrations are reversible (up and down)
5. Migration history is logged
6. Backward compatibility is maintained for N-1 versions
7. Schema validation runs after migration
8. Migration failures preserve original state
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [x] Task 1: Implement Version Tracking (AC: 1)
  - [x] Add STATE_VERSION constant
  - [x] Add version field to state files
  - [x] Display version in state info

- [x] Task 2: Create Migration Framework (AC: 2, 3, 4)
  - [x] Create `geusemaker/infra/migrations/` directory
  - [x] Implement `MigrationRunner` class
  - [x] Create base Migration class
  - [x] Support up() and down() methods

- [x] Task 3: Implement Auto-Migration (AC: 3)
  - [x] Check version on state load
  - [x] Run required migrations
  - [x] Update version after migration
  - [x] Save migrated state

- [x] Task 4: Implement Migration Logging (AC: 5)
  - [x] Log migration start/end
  - [x] Log changes made
  - [x] Track migration history in state

- [x] Task 5: Implement Backward Compatibility (AC: 6)
  - [x] Define compatibility policy (N-1 versions)
  - [x] Warn on incompatible versions
  - [x] Provide manual migration options

- [x] Task 6: Implement Validation (AC: 7)
  - [x] Validate schema after migration
  - [x] Report validation errors
  - [x] Rollback on validation failure

- [x] Task 7: Implement Failure Handling (AC: 8)
  - [x] Preserve original state on failure
  - [x] Provide recovery instructions
  - [x] Log detailed error info

- [x] Task 8: Create Unit Tests (AC: 9)
  - [x] Test version detection
  - [x] Test migration execution
  - [x] Test rollback on failure
  - [x] Achieve 80%+ coverage

## Dev Notes

### File Locations
```
geusemaker/
├── infra/
│   ├── state.py
│   └── migrations/
│       ├── __init__.py
│       ├── runner.py
│       └── v1_to_v2.py
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
