# Story 4.9: UserData Log Display After Deployment

## Status
Done

## Story

**As a** developer deploying with GeuseMaker,
**I want** to see the UserData initialization logs displayed in my CLI after deployment,
**so that** I can verify the server-side setup completed successfully and troubleshoot any issues.

## Acceptance Criteria

1. UserData logs are automatically fetched and displayed after EC2 instance launch
2. System waits for SSM agent to be ready before attempting log retrieval
3. System waits for UserData completion (checks guard file) before fetching logs
4. Logs are displayed using Rich formatting with proper styling
5. Falls back to cloud-init-output.log if geusemaker-userdata.log is not available
6. Handles cases where logs are not yet available gracefully
7. Logs are displayed in a scrollable panel format
8. Implementation uses SSM send_command and get_command_invocation for log retrieval
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [x] Task 1: Add UserData Log Fetching to SSMService (AC: 1, 8)
  - [x] Add `fetch_userdata_logs(instance_id: str, wait_for_completion: bool = True) -> str` method
  - [x] Implement SSM agent readiness check (wait 30-60 seconds after instance start)
  - [x] Implement UserData completion check (poll for `/var/lib/geusemaker/userdata-complete` guard file)
  - [x] Implement log file fetching via SSM `send_command()` and `get_command_invocation()`
  - [x] Try `/var/log/geusemaker-userdata.log` first, fallback to `/var/log/cloud-init-output.log`
  - [x] Handle timeout scenarios gracefully
  - [x] Return log content as string

- [x] Task 2: Integrate Log Display into Tier1 Orchestrator (AC: 1, 2, 3, 4, 5, 6, 7)
  - [x] Import SSMService in `geusemaker/cli/interactive/runner.py` (integrated in runner instead of orchestrator)
  - [x] After instance launch and `wait_for_running()`, wait for SSM agent readiness
  - [x] Call `fetch_userdata_logs()` with `wait_for_completion=True`
  - [x] Display logs using Rich Panel with cyan border
  - [x] Show appropriate emoji and title ("UserData Initialization Logs")
  - [x] Handle exceptions gracefully with warning messages
  - [x] Display logs before final success message

- [x] Task 3: Add Log Display to Deployment Success Flow (AC: 1, 7)
  - [x] Ensure logs are displayed in both interactive and non-interactive modes
  - [x] Add log display to `DeploymentRunner` success path
  - [x] Consider adding `--show-logs/--no-show-logs` flag for optional display (deferred to future enhancement)
  - [x] Ensure logs don't block deployment completion if unavailable

- [x] Task 4: Create Unit Tests (AC: 9)
  - [x] Create `tests/unit/test_services/test_ssm.py` if not exists
  - [x] Test `fetch_userdata_logs()` with mocked SSM responses
  - [x] Test SSM agent readiness waiting logic
  - [x] Test UserData completion polling
  - [x] Test log file fallback behavior
  - [x] Test timeout handling
  - [x] Test orchestrator integration with mocked SSMService
  - [x] Achieve 80%+ coverage (achieved 100% for new code with 14 tests)

## Dev Notes

### Previous Story Insights
From Story 4.5: UserData script logs to `/var/log/geusemaker-userdata.log` and creates guard file at `/var/lib/geusemaker/userdata-complete`.
From Story 4.6: Orchestrator launches EC2 with UserData and waits for instance to be running.

### AWS Best Practices
[Source: AWS Documentation Research via Web Search]

**SSM Run Command Pattern:**
```python
# Send command to fetch log file
response = ssm.send_command(
    InstanceIds=[instance_id],
    DocumentName="AWS-RunShellScript",
    Parameters={
        "commands": ["cat /var/log/geusemaker-userdata.log"]
    }
)

# Poll for output
command_id = response["Command"]["CommandId"]
result = ssm.get_command_invocation(
    CommandId=command_id,
    InstanceId=instance_id
)
log_content = result["StandardOutputContent"]
```

**SSM Agent Readiness:**
- SSM agent typically ready 30-60 seconds after instance start
- Can check agent status via `describe_instance_information()` or wait with timeout

**UserData Completion:**
- UserData script creates guard file when complete
- Check for `/var/lib/geusemaker/userdata-complete` file existence
- Poll every 10 seconds, max wait 5 minutes

### Data Models
[Source: architecture/4-data-models.md]

No new models required. Uses existing `SSMService` and `DeploymentState`.

### CLI Specifications
[Source: architecture/5-components.md#5.1]

**Automatic Display:**
- Logs displayed automatically after deployment completes
- No separate command required (integrated into deploy flow)

**Optional Flag (Future Enhancement):**
```bash
# Show logs after deployment (default: true)
geusemaker deploy --show-logs

# Skip log display
geusemaker deploy --no-show-logs
```

**Log Display Format:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UserData Initialization Logs                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ===================================                          â”‚
â”‚ GeuseMaker UserData Initialization                           â”‚
â”‚ Stack: my-stack                                              â”‚
â”‚ Tier: dev                                                    â”‚
â”‚ Timestamp: 2025-01-21T10:30:00Z                              â”‚
â”‚ ===================================                          â”‚
â”‚ Starting GeuseMaker initialization...                        â”‚
â”‚ Installing Docker...                                         â”‚
â”‚ Mounting EFS...                                              â”‚
â”‚ Starting Docker Compose services...                          â”‚
â”‚ âœ… All services started successfully                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ ssm.py                 # Add fetch_userdata_logs() method
â”œâ”€â”€ orchestration/
â”‚   â””â”€â”€ tier1.py               # Integrate log display after instance launch
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ test_services/
â”‚       â””â”€â”€ test_ssm.py        # Test log fetching
â”‚   â””â”€â”€ test_orchestration/
â”‚       â””â”€â”€ test_tier1.py      # Test orchestrator integration
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- SSM agent must be ready before sending commands (wait 30-60 seconds)
- UserData completion can take 2-5 minutes (set reasonable timeout)
- Use `asyncio.to_thread()` for blocking SSM calls if needed
- Handle SSM failures gracefully (instance may not have SSM agent ready)
- Log display should not block deployment completion
- Use Rich Panel for formatted log display
- Follow existing error handling patterns

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test `fetch_userdata_logs()` returns log content when available
2. Test SSM agent readiness waiting logic
3. Test UserData completion polling with guard file check
4. Test fallback to cloud-init-output.log
5. Test timeout handling when logs never become available
6. Test orchestrator displays logs after instance launch
7. Test graceful handling when SSM commands fail
8. Test log display formatting with Rich Panel

**Mocking Strategy:**
- Mock SSM `send_command()` and `get_command_invocation()` responses
- Mock instance state transitions
- Mock file existence checks via SSM commands
- Use moto for SSM service mocking in unit tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-11-25 | 1.1 | Story implementation completed | James (Dev Agent) |

## Implementation Notes

### Files Modified
- [geusemaker/services/ssm.py](../../geusemaker/services/ssm.py) - Added three new methods: `wait_for_ssm_agent()`, `wait_for_userdata_completion()`, and `fetch_userdata_logs()`
- [geusemaker/cli/interactive/runner.py](../../geusemaker/cli/interactive/runner.py) - Added `_display_userdata_logs()` method and integrated into deployment flow
- [geusemaker/cli/branding.py](../../geusemaker/cli/branding.py) - Added "log" emoji (ğŸ“‹)
- [tests/unit/test_cli/test_commands/test_deploy.py](../../tests/unit/test_cli/test_commands/test_deploy.py) - Fixed DummyOrchestrator to include instance_id attribute

### Files Created
- [tests/unit/test_services/test_ssm.py](../../tests/unit/test_services/test_ssm.py) - 11 comprehensive test cases for SSM log fetching
- [tests/unit/test_cli/test_runner.py](../../tests/unit/test_cli/test_runner.py) - 3 test cases for runner log display integration

### Test Results
- All 142 tests passing (128 existing + 14 new)
- 100% coverage achieved for new code
- All linting and type checks passing

### Key Implementation Decisions
1. **Integration Point**: Logs displayed in `DeploymentRunner.run()` after orchestrator.deploy() returns, not within orchestrator itself. This keeps orchestration layer focused on AWS resource management.
2. **Error Handling**: Log fetching failures result in warnings, not deployment failures. This ensures deployment success isn't blocked by transient SSM issues.
3. **Timeouts**: SSM agent wait: 60s, UserData completion wait: 300s (5 minutes).
4. **Test Strategy**: Used unittest.mock instead of moto for SSM-specific methods due to moto limitations with describe_instance_information.

## Dependencies

- Requires: Story 4.5 (UserData Script Generation) - for log file location and guard file
- Requires: Story 4.6 (Deployment Orchestrator) - for integration point
- Requires: SSMService implementation (already exists)
- Blocks: None (enhancement feature)

## Related Stories

- Story 4.5: UserData Script Generation - Creates the logs being displayed
- Story 4.6: Deployment Orchestrator - Integration point for log display
- Story 9.5: Informational Display Command - Could extend `logs` command to show UserData logs on demand

