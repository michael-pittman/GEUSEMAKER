# Story 13.3: CloudFront Orchestrator Implementation

## Status
Draft

## Story

**As a** user deploying Tier 3 workloads,
**I want** the deployment orchestrator to coordinate CloudFront creation,
**so that** my deployment includes CDN with proper sequencing after ALB.

## Acceptance Criteria

1. Tier 3 orchestrator extends Tier 2 orchestrator
2. CloudFront is created after ALB is active
3. CloudFront uses ALB DNS as origin
4. Orchestrator waits for CloudFront to deploy
5. GPU instances are launched when specified
6. Deployment fails gracefully if CloudFront fails
7. Rollback removes CloudFront on failure
8. Progress is reported during CloudFront deployment
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Tier 3 Orchestrator (AC: 1)
  - [ ] Create `src/geusemaker/orchestrators/tier3_orchestrator.py`
  - [ ] Extend Tier 2 orchestrator
  - [ ] Override deployment workflow

- [ ] Task 2: Integrate CloudFront in Deployment Flow (AC: 2, 3)
  - [ ] Add CloudFront creation step after ALB
  - [ ] Pass ALB DNS as origin
  - [ ] Configure caching behaviors

- [ ] Task 3: Wait for CloudFront Deployment (AC: 4)
  - [ ] Poll distribution status
  - [ ] Wait until "Deployed"
  - [ ] Configurable timeout (up to 30 min)
  - [ ] Report progress during wait

- [ ] Task 4: Integrate GPU Instance Support (AC: 5)
  - [ ] Check if GPU instance requested
  - [ ] Select GPU AMI
  - [ ] Generate GPU UserData
  - [ ] Validate GPU post-launch

- [ ] Task 5: Handle CloudFront Failures (AC: 6)
  - [ ] Catch CloudFront creation errors
  - [ ] Provide meaningful error messages
  - [ ] Include AWS error details
  - [ ] Suggest remediation steps

- [ ] Task 6: Implement CloudFront Rollback (AC: 7)
  - [ ] Disable CloudFront distribution
  - [ ] Delete CloudFront distribution
  - [ ] Handle deletion wait time
  - [ ] Continue with ALB rollback

- [ ] Task 7: Report CloudFront Progress (AC: 8)
  - [ ] Show "Creating CloudFront distribution..."
  - [ ] Show "Waiting for deployment..."
  - [ ] Show progress percentage if available
  - [ ] Show final CloudFront domain

- [ ] Task 8: Create Unit Tests (AC: 9)
  - [ ] Test orchestrator initialization
  - [ ] Test deployment workflow
  - [ ] Test CloudFront integration
  - [ ] Test GPU support
  - [ ] Test rollback
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Architecture References
- See `docs/architecture/ARCHITECTURE.md` for orchestrator patterns
- Tier 3 orchestrator inherits from Tier 2 orchestrator
- Uses composition for CloudFront service

### Deployment Sequence
```
1. VPC/Subnet selection (inherited)
2. Security Group creation (inherited)
3. EFS creation (inherited)
4. EC2 instance launch (extended for GPU)
5. ALB creation (inherited)
6. Target registration (inherited)
7. CloudFront creation (new)
8. Wait for CloudFront (new)
9. Return deployment state (updated)
```

### CloudFront Deployment Time
- CloudFront can take 15-30 minutes to deploy
- Use configurable timeout
- Consider async deployment option

### GPU Flow
```
1. Validate GPU instance type
2. Select Deep Learning AMI
3. Generate GPU-enabled UserData
4. Launch GPU instance
5. Validate GPU access post-launch
```

## Testing

### Unit Tests
- Mock CloudFront service
- Test deployment workflow integration
- Test GPU instance selection
- Test CloudFront wait logic
- Test rollback procedures

### Integration Tests
- Full Tier 3 deployment
- Verify CloudFront serves traffic
- Test GPU deployment (if resources available)
- Test failure and rollback

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
