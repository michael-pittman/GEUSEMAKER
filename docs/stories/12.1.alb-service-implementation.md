# Story 12.1: ALB Service Implementation

## Status
Draft

## Story

**As a** user deploying Tier 2 workloads,
**I want** an Application Load Balancer to be created and configured,
**so that** my services have high availability and load balancing capabilities.

## Acceptance Criteria

1. ALB is created with correct configuration
2. Target groups are created for each service
3. Health checks are configured for target groups
4. Listeners are created on ports 80 and 443
5. Listener rules route traffic to correct services
6. ALB DNS name is returned after creation
7. ALB waits until active state before returning
8. Security groups are configured for ALB
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create ALB Service Class (AC: 1)
  - [ ] Create `src/geusemaker/services/alb_service.py`
  - [ ] Implement ALBService class
  - [ ] Accept VPC, subnets, security groups

- [ ] Task 2: Implement ALB Creation (AC: 1, 6)
  - [ ] Create application load balancer
  - [ ] Configure scheme (internet-facing/internal)
  - [ ] Apply standard tags
  - [ ] Return ALB ARN and DNS

- [ ] Task 3: Create Target Groups (AC: 2)
  - [ ] Create target group per service (n8n, Ollama, Qdrant, Crawl4AI)
  - [ ] Configure target type (instance)
  - [ ] Set protocol and port
  - [ ] Configure stickiness if needed

- [ ] Task 4: Configure Health Checks (AC: 3)
  - [ ] Set health check path per service
  - [ ] Configure intervals and thresholds
  - [ ] Set healthy/unhealthy thresholds
  - [ ] Configure timeout settings

- [ ] Task 5: Create Listeners (AC: 4)
  - [ ] Create HTTP listener on port 80
  - [ ] Create HTTPS listener on port 443 (optional)
  - [ ] Configure SSL certificate (if HTTPS)
  - [ ] Set default action

- [ ] Task 6: Configure Listener Rules (AC: 5)
  - [ ] Create path-based routing rules
  - [ ] Route /n8n/* to n8n target group
  - [ ] Route /ollama/* to Ollama target group
  - [ ] Route /qdrant/* to Qdrant target group
  - [ ] Route /crawl4ai/* to Crawl4AI target group

- [ ] Task 7: Wait for ALB Active State (AC: 7)
  - [ ] Poll ALB state
  - [ ] Wait until state is "active"
  - [ ] Timeout after configurable period
  - [ ] Handle provisioning errors

- [ ] Task 8: Configure Security Groups (AC: 8)
  - [ ] Create or use ALB security group
  - [ ] Allow inbound HTTP (80)
  - [ ] Allow inbound HTTPS (443)
  - [ ] Allow outbound to targets

- [ ] Task 9: Create Unit Tests (AC: 9)
  - [ ] Test ALB creation
  - [ ] Test target group creation
  - [ ] Test listener configuration
  - [ ] Test health check configuration
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Architecture References
- See `docs/architecture/ARCHITECTURE.md` for service layer patterns
- ALB service follows same patterns as EC2 and EFS services
- Uses boto3 ELBv2 client

### Service Port Mappings
```python
SERVICE_PORTS = {
    "n8n": 5678,
    "ollama": 11434,
    "qdrant": 6333,
    "crawl4ai": 8000,
    "postgres": 5432  # Not exposed via ALB
}
```

### Health Check Paths
```python
HEALTH_CHECK_PATHS = {
    "n8n": "/healthz",
    "ollama": "/api/version",
    "qdrant": "/health",
    "crawl4ai": "/health"
}
```

### ALB Configuration
- Internet-facing by default
- Cross-zone load balancing enabled
- Idle timeout: 60 seconds
- HTTP/2 enabled

## Testing

### Unit Tests
- Mock boto3 ELBv2 client with moto
- Test ALB creation with various configurations
- Test target group creation and configuration
- Test listener and rule creation
- Test health check configuration
- Test wait for active state

### Integration Tests
- Create ALB in test VPC
- Verify target group registration
- Verify health checks work
- Clean up after tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
