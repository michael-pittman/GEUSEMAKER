# Story 6.4: Resource Cleanup and Orphan Detection

## Status
Done

## Story

**As a** developer managing AWS resources,
**I want** the system to detect and clean up orphaned resources,
**so that** I don't incur costs from forgotten or partially deleted deployments.

## Acceptance Criteria

1. `geusemaker cleanup` detects orphaned GeuseMaker resources
2. Orphan detection finds resources with GeuseMaker tags but no active deployment
3. Cleanup displays orphaned resources with age and estimated cost
4. Cleanup allows selective deletion of orphaned resources
5. Cleanup supports `--dry-run` to preview without deleting
6. Cleanup supports `--all` to delete all orphans without prompting
7. Cleanup generates a cleanup report
8. Cleanup can scan multiple regions
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create Cleanup Command (AC: 1, 5, 6)
  - [ ] Create `geusemaker/cli/commands/cleanup.py`
  - [ ] Implement `cleanup` Click command
  - [ ] Support `--dry-run` flag
  - [ ] Support `--all` flag
  - [ ] Support `--region` flag (or all regions)

- [ ] Task 2: Create Orphan Detection Service (AC: 2)
  - [ ] Create `geusemaker/services/cleanup/__init__.py`
  - [ ] Create `geusemaker/services/cleanup/detector.py`
  - [ ] Implement `OrphanDetector` class
  - [ ] Implement `detect_orphans(region: str) -> list[OrphanedResource]`
  - [ ] Scan for resources with `geusemaker:deployment` tag

- [ ] Task 3: Implement EC2 Orphan Detection (AC: 2)
  - [ ] Find running instances with GeuseMaker tags
  - [ ] Check if deployment state exists for instance
  - [ ] Mark as orphan if no matching deployment
  - [ ] Include instance age and estimated cost

- [ ] Task 4: Implement EFS Orphan Detection (AC: 2)
  - [ ] Find EFS file systems with GeuseMaker tags
  - [ ] Check if deployment state exists for EFS
  - [ ] Mark as orphan if no matching deployment
  - [ ] Include EFS size and cost estimate

- [ ] Task 5: Implement VPC/SG Orphan Detection (AC: 2)
  - [ ] Find VPCs with GeuseMaker tags
  - [ ] Find security groups with GeuseMaker tags
  - [ ] Check for associated active deployments
  - [ ] Mark as orphan if unused

- [ ] Task 6: Implement ALB/CloudFront Orphan Detection (AC: 2)
  - [ ] Find ALBs with GeuseMaker tags
  - [ ] Find CloudFront distributions with GeuseMaker tags
  - [ ] Check for associated active deployments
  - [ ] Mark as orphan if unused

- [ ] Task 7: Implement Orphan Display (AC: 3)
  - [ ] Display orphans in Rich table
  - [ ] Show resource type, ID, name, age
  - [ ] Show estimated monthly cost for each
  - [ ] Group by region and resource type

- [ ] Task 8: Implement Selective Deletion (AC: 4)
  - [ ] Allow user to select resources to delete
  - [ ] Use checkbox/multiselect UI
  - [ ] Confirm selection before deletion
  - [ ] Delete in correct dependency order

- [ ] Task 9: Implement Multi-Region Scan (AC: 8)
  - [ ] Support `--region all` to scan all regions
  - [ ] Parallelize region scans for performance
  - [ ] Aggregate results from all regions
  - [ ] Show region in results

- [ ] Task 10: Implement Cleanup Report (AC: 7)
  - [ ] Generate cleanup report
  - [ ] Include deleted and preserved resources
  - [ ] Include total cost savings
  - [ ] Support JSON export

- [ ] Task 11: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_cleanup/test_detector.py`
  - [ ] Test orphan detection logic
  - [ ] Test EC2 orphan detection
  - [ ] Test EFS orphan detection
  - [ ] Test selective deletion
  - [ ] Test dry-run mode
  - [ ] Achieve 80%+ coverage

## Dev Notes

### Previous Story Insights
From Story 3.4: Resource tagging with `geusemaker:` prefix enables detection.
From Story 6.3: Destruction service handles resource deletion.

### Data Models
[Source: architecture/4-data-models.md]

**OrphanedResource Model (new):**
- `resource_type`: str
- `resource_id`: str
- `name`: Optional[str]
- `region`: str
- `deployment_tag`: str (the deployment name from tag)
- `created_at`: datetime
- `age_days`: int
- `estimated_monthly_cost`: Decimal
- `tags`: dict[str, str]

**CleanupReport Model (new):**
- `scanned_regions`: list[str]
- `orphans_found`: int
- `orphans_deleted`: int
- `orphans_preserved`: int
- `estimated_monthly_savings`: Decimal
- `deleted_resources`: list[DeletedResource]
- `errors`: list[str]

### CLI Specifications
[Source: architecture/5-components.md#5.1]

**Cleanup Command Usage:**
```bash
# Scan current region for orphans
geusemaker cleanup

# Dry run (show orphans without deleting)
geusemaker cleanup --dry-run

# Delete all orphans without prompting
geusemaker cleanup --all

# Scan specific region
geusemaker cleanup --region us-west-2

# Scan all regions
geusemaker cleanup --region all
```

**Cleanup Display:**
```
╭──────────── Orphaned Resources ────────────╮
│                                             │
│  Found 3 orphaned resources:               │
│                                             │
│  Type     │ ID           │ Age  │ Cost/mo  │
│  ─────────┼──────────────┼──────┼────────  │
│  EC2      │ i-abc123     │ 7d   │ $25.00   │
│  EFS      │ fs-xyz789    │ 14d  │ $5.00    │
│  SG       │ sg-def456    │ 30d  │ $0.00    │
│                                             │
│  Total estimated monthly savings: $30.00   │
│                                             │
│  Select resources to delete (space to      │
│  select, enter to confirm):                │
╰─────────────────────────────────────────────╯
```

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
├── services/
│   └── cleanup/
│       ├── __init__.py
│       └── detector.py     # Orphan detection
├── cli/
│   └── commands/
│       └── cleanup.py      # Cleanup command
tests/
├── unit/
│   └── test_services/
│       └── test_cleanup/
│           └── test_detector.py
```

### Technical Constraints
[Source: architecture/12-coding-standards.md]

- Tag-based detection requires consistent tagging
- Some orphans may be intentionally preserved
- Multi-region scan may take several minutes
- Cost estimates are approximations
- Handle resources that fail to delete

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test Cases:**
1. Test orphan detection finds tagged resources
2. Test orphan detection excludes active deployments
3. Test cost estimation is reasonable
4. Test dry-run doesn't delete anything
5. Test selective deletion works
6. Test multi-region scan aggregates results
7. Test cleanup report is generated

**Mocking Strategy:**
- Mock AWS describe APIs with tagged resources
- Mock StateManager to simulate missing deployments
- Test orphan classification logic

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results

**Reviewed by:** Quinn (QA Agent)  
**Review Date:** 2025-01-21  
**Status:** ✅ **APPROVED WITH DEPENDENCY VERIFICATION**

### Strengths
- ✅ Comprehensive orphan detection across all resource types
- ✅ Multi-region scanning capability
- ✅ Cost estimation for orphaned resources
- ✅ Selective deletion with dry-run support
- ✅ Excellent safety measures (confirmation, dry-run)

### Issues Identified

1. **⚠️ Task 2 - Tagging Dependency**
   - **Issue**: Orphan detection relies on `geusemaker:deployment` tag
   - **Impact**: Cannot detect orphans without consistent tagging
   - **Dependency Status**: ✅ **VERIFIED** - Story 3.4 (Resource Tagging) is Done
   - **Recommendation**: Implementation can proceed; tagging is available
   - **Priority**: Low (dependency satisfied)

2. **ℹ️ Task 9 - Multi-Region Performance**
   - **Issue**: Mentions "may take several minutes" but no progress indicator
   - **Impact**: Users may think operation is stuck
   - **Recommendation**: Add subtask to implement progress indicators for long-running scans
   - **Priority**: Low

3. **⚠️ Missing - Failed Deletion Handling**
   - **Issue**: Constraints mention "Handle resources that fail to delete" but not in tasks
   - **Impact**: No explicit implementation for handling deletion failures
   - **Recommendation**: Add explicit task:
     - Task 12: Implement Failed Deletion Handling
       - [ ] Detect resources that fail to delete
       - [ ] Retry failed deletions with exponential backoff
       - [ ] Report failed deletions in cleanup report
       - [ ] Provide manual cleanup instructions
   - **Priority**: Medium

4. **ℹ️ Task 7 - Cost Estimation Accuracy**
   - **Issue**: Cost estimates are approximations but accuracy not specified
   - **Impact**: Users may rely on inaccurate estimates
   - **Recommendation**: Add note that estimates are approximate and based on current pricing
   - **Priority**: Low

### Dependency Validation
- ✅ Epic 3 dependency (tagging) - **VERIFIED**: Story 3.4 is Done
- ✅ Epic 6 dependency (destruction service) - Story 6.3 provides destruction patterns

### Test Coverage Assessment
- ✅ Test cases cover orphan detection and cleanup
- ✅ Mocking strategy is appropriate
- ⚠️ Consider adding integration tests for multi-region scanning

### Overall Assessment
Story is well-structured and tagging dependency is satisfied. Orphan detection can proceed. Minor enhancement needed for failed deletion handling and progress indicators.
