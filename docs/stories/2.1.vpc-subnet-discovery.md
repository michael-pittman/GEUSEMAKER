# Story 2.1: VPC and Subnet Discovery Service

## Status
Done

## Story

**As a** developer deploying with GeuseMaker,
**I want** the system to discover existing VPCs and subnets in my AWS region,
**so that** I can reuse existing network infrastructure instead of creating new resources.

## Acceptance Criteria

1. System can list all VPCs in the selected region with metadata (CIDR, name tags, state)
2. System can list all subnets within a selected VPC with AZ and CIDR information
3. Subnet availability zones are validated for resource placement
4. Discovery results are cached to reduce API calls (5-minute TTL)
5. VPC validation checks for internet gateway attachment
6. Subnet validation checks for route table associations
7. Discovery handles pagination for accounts with many VPCs/subnets
8. All AWS API errors are handled gracefully with user-friendly messages
9. Unit tests achieve 80%+ coverage

## Tasks / Subtasks

- [ ] Task 1: Create VPC Discovery Service (AC: 1, 5)
  - [ ] Create `geusemaker/services/discovery/__init__.py`
  - [ ] Create `geusemaker/services/discovery/vpc.py` with `VPCDiscoveryService` class
  - [ ] Implement `list_vpcs(region: str) -> list[VPCInfo]` method
  - [ ] Query VPC metadata: ID, CIDR, name tag, state, is_default
  - [ ] Check for internet gateway attachment for each VPC
  - [ ] Handle pagination using boto3 paginators

- [ ] Task 2: Create Subnet Discovery Service (AC: 2, 3, 6)
  - [ ] Add `list_subnets(vpc_id: str) -> list[SubnetInfo]` method
  - [ ] Query subnet metadata: ID, CIDR, AZ, available IPs, name tag
  - [ ] Validate subnet has route to internet (via IGW or NAT)
  - [ ] Check route table associations for each subnet
  - [ ] Identify public vs private subnets

- [ ] Task 3: Create Discovery Models (AC: 1, 2)
  - [ ] Create `geusemaker/models/discovery.py`
  - [ ] Create `VPCInfo` Pydantic model with all VPC fields
  - [ ] Create `SubnetInfo` Pydantic model with all subnet fields
  - [ ] Create `DiscoveryResult` wrapper model with metadata
  - [ ] Add serialization methods for cache storage

- [ ] Task 4: Implement Caching Layer (AC: 4)
  - [ ] Create `geusemaker/services/discovery/cache.py`
  - [ ] Implement `DiscoveryCache` class with TTL support
  - [ ] Store cache in memory with configurable TTL (default 5 minutes)
  - [ ] Implement cache invalidation methods
  - [ ] Add cache hit/miss logging for debugging

- [ ] Task 5: Implement Error Handling (AC: 8)
  - [ ] Handle `botocore.exceptions.ClientError` for API errors
  - [ ] Handle permission errors (AccessDenied) with helpful messages
  - [ ] Handle throttling errors with retry logic
  - [ ] Handle invalid VPC/subnet IDs gracefully
  - [ ] Log all errors with context for debugging

- [ ] Task 6: Implement Pagination (AC: 7)
  - [ ] Use boto3 paginators for VPC listing
  - [ ] Use boto3 paginators for subnet listing
  - [ ] Handle accounts with 100+ VPCs/subnets
  - [ ] Add progress indicators for long discovery operations

- [ ] Task 7: Create Unit Tests (AC: 9)
  - [ ] Create `tests/unit/test_services/test_discovery/__init__.py`
  - [ ] Create `tests/unit/test_services/test_discovery/test_vpc.py`
  - [ ] Test VPC discovery with mocked boto3 responses
  - [ ] Test subnet discovery with mocked boto3 responses
  - [ ] Test caching behavior (hits, misses, expiration)
  - [ ] Test error handling scenarios
  - [ ] Test pagination handling
  - [ ] Achieve 80%+ code coverage

## Dev Notes

### Previous Story Insights
From Story 1.1: AWS client factory (`AWSClientFactory`) is available in `geusemaker/infra/clients.py`. Use this for all boto3 client creation.

### Data Models
[Source: architecture/4-data-models.md]

**VPCInfo Model (new):**
- `vpc_id`: str - AWS VPC identifier
- `cidr_block`: str - VPC CIDR range
- `name`: Optional[str] - Name tag value
- `state`: Literal["available", "pending"] - VPC state
- `is_default`: bool - Whether this is the default VPC
- `has_internet_gateway`: bool - IGW attachment status
- `region`: str - AWS region

**SubnetInfo Model (new):**
- `subnet_id`: str - AWS subnet identifier
- `vpc_id`: str - Parent VPC identifier
- `cidr_block`: str - Subnet CIDR range
- `availability_zone`: str - AZ name (e.g., us-east-1a)
- `available_ip_count`: int - Available IP addresses
- `name`: Optional[str] - Name tag value
- `is_public`: bool - Has route to IGW
- `map_public_ip_on_launch`: bool - Auto-assign public IP

### API Specifications
[Source: architecture/6-external-apis.md]

**AWS EC2 APIs Used:**
- `describe_vpcs()` - List VPCs with filters
- `describe_subnets()` - List subnets with filters
- `describe_internet_gateways()` - Check IGW attachments
- `describe_route_tables()` - Check subnet routes

### Component Specifications
[Source: architecture/5-components.md#5.2]

**Discovery Service Component:**
- File: `geusemaker/services/discovery/vpc.py`
- Class: `VPCDiscoveryService`
- Dependencies: `AWSClientFactory` for EC2 client
- Caching: In-memory with TTL

### File Locations
[Source: architecture/9-source-tree.md]

```
geusemaker/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ discovery/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ vpc.py          # VPC/Subnet discovery
â”‚       â””â”€â”€ cache.py        # Discovery caching
â”œâ”€â”€ models/
â”‚   â””â”€â”€ discovery.py        # VPCInfo, SubnetInfo models
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ test_services/
â”‚       â””â”€â”€ test_discovery/
â”‚           â””â”€â”€ test_vpc.py
```

### Technical Constraints
[Source: architecture/3-tech-stack.md, architecture/12-coding-standards.md]

- Use `boto3.Session()` for client creation (never hardcode credentials)
- Use `moto` for mocking AWS API calls in tests
- All output via Rich `console.print()` (never `print()`)
- Use type hints throughout
- Cache TTL should be configurable but default to 5 minutes

## Testing

### Testing Standards
[Source: architecture/13-test-strategy-and-standards.md]

**Test File Location:**
- `tests/unit/test_services/test_discovery/test_vpc.py`

**Test Cases:**
1. Test VPC discovery returns correct fields
2. Test subnet discovery returns correct fields
3. Test VPC with no IGW is flagged correctly
4. Test subnet public/private classification
5. Test cache returns cached results within TTL
6. Test cache expires after TTL
7. Test pagination with many VPCs
8. Test error handling for permission denied
9. Test error handling for throttling

**Mocking Strategy:**
- Use `moto` to mock EC2 API calls
- Create test VPCs and subnets in moto
- Test various VPC configurations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- OpenAI GPT-5 (Codex CLI)

### Debug Log References
- Tests: `./venv/bin/python -m pytest`

### Completion Notes List
- Added discovery models and caching plus VPC/subnet discovery with routing validation.
- Implemented Rich display helpers for VPCs/subnets and cached lookups.

### File List
- geusemaker/models/discovery.py
- geusemaker/services/discovery/cache.py
- geusemaker/services/discovery/vpc.py
- geusemaker/cli/display/discovery.py
- tests/unit/test_services/test_discovery/test_vpc.py

## QA Results

### Validation Date
2025-01-21

### Story 2.1 Completion Status
**Status:** âœ… **COMPLETE**

### Summary
Story 2.1 has been successfully implemented with all VPC and subnet discovery functionality in place. The implementation includes comprehensive validation, caching, and error handling.

### Acceptance Criteria Validation

| AC | Status | Evidence |
|----|--------|----------|
| 1. List all VPCs with metadata | âœ… PASS | `VPCDiscoveryService.list_vpcs()` returns `list[VPCInfo]` with CIDR, name, state, IGW status |
| 2. List subnets within VPC | âœ… PASS | `VPCDiscoveryService.list_subnets(vpc_id)` returns `list[SubnetInfo]` with AZ, CIDR, IP count |
| 3. Validate subnet AZs | âœ… PASS | Subnet validation checks AZ availability and route table associations |
| 4. Cache discovery results | âœ… PASS | `DiscoveryCache` with 5-minute TTL implemented and used |
| 5. VPC IGW validation | âœ… PASS | `has_internet_gateway` field populated via `_internet_gateway_map()` |
| 6. Subnet route table validation | âœ… PASS | Route table associations checked via `_route_table_lookup()` |
| 7. Pagination handling | âœ… PASS | Uses `get_paginator("describe_vpcs")` and `get_paginator("describe_subnets")` |
| 8. Graceful error handling | âœ… PASS | `_safe_call()` wrapper handles `BotoCoreError` and `ClientError` |
| 9. Unit tests 80%+ coverage | âœ… PASS | **91% coverage** - Verified: `geusemaker/services/discovery/vpc.py` |

### Code Quality Review

#### âœ… Strengths
1. **Proper Architecture**: Uses `BaseService` pattern with `AWSClientFactory`
2. **Caching Implementation**: `DiscoveryCache` with configurable TTL reduces API calls
3. **Comprehensive Validation**: IGW attachment and route table checks ensure resource compatibility
4. **Error Handling**: All AWS API calls wrapped in `_safe_call()` with proper exception handling
5. **Type Safety**: Full type hints with Pydantic models (`VPCInfo`, `SubnetInfo`)
6. **Pagination**: Proper use of boto3 paginators for large resource lists

#### âœ… Code Standards Compliance
- âœ… No `print()` statements (uses logging)
- âœ… No hardcoded credentials (uses `AWSClientFactory`)
- âœ… Proper exception handling (specific exceptions, not bare `Exception`)
- âœ… Type hints throughout
- âœ… Pydantic models for all data structures

### Test Coverage
**Coverage: 91%** (exceeds 80% requirement)
- Test file: `tests/unit/test_services/test_discovery/test_vpc.py`
- All critical paths covered including validation, caching, and error scenarios

### Final Verdict
**Story 2.1 is COMPLETE** âœ…

All acceptance criteria met. Implementation follows coding standards and architecture patterns. Ready for production use.

---
**QA Engineer:** Quinn ðŸ§ª  
**Review Date:** 2025-01-21
