# ===================================
# Post-Startup Health Verification
# ===================================

echo "Running post-startup health checks..."

# Ensure run_compose helper exists (when services block was skipped)
if ! declare -f run_compose >/dev/null 2>&1; then
    run_compose() {
        local compose_dir
        compose_dir="$(dirname "$COMPOSE_FILE_PATH")"
        if [ ! -d "$compose_dir" ]; then
            echo "ERROR: Compose directory not found: $compose_dir"
            return 1
        fi
        # Source runtime.env so Compose variable interpolation works (env_file only populates containers)
        if [ -f "$RUNTIME_ENV_FILE" ]; then
            set -a
            # shellcheck disable=SC2046
            while IFS='=' read -r key value; do
                [ -z "$key" ] && continue
                case "$key" in
                    \#*) continue ;;
                esac
                export "$key=$value"
            done < "$RUNTIME_ENV_FILE"
            set +a
        fi
        if command -v docker-compose >/dev/null 2>&1; then
            (cd "$compose_dir" && docker-compose -f "$COMPOSE_FILE_PATH" "$@")
        else
            (cd "$compose_dir" && docker compose -f "$COMPOSE_FILE_PATH" "$@")
        fi
    }
fi

# Wait for services to fully initialize
sleep 30

# Check Docker daemon
if ! docker info > /dev/null 2>&1; then
    echo "WARNING: Docker daemon not responding"
fi

# Check EFS mount
if ! mountpoint -q /mnt/efs; then
    echo "WARNING: EFS not mounted"
fi

# Check container health
echo "Container status:"
run_compose ps

# Check individual service health
check_service() {
    local service=$1
    local port=$2
    local path=${3:-/}

    echo "Checking $service on port $port..."

    # Verify curl is available for health checks
    if ! verify_curl; then
        echo "✗ $service health check skipped (curl not available)"
        return
    fi

    # Use curl with explicit timeout to prevent hanging
    if curl -sf --connect-timeout 5 --max-time 10 "http://localhost:$port$path" > /dev/null 2>&1; then
        echo "✓ $service is healthy"
    else
        echo "✗ $service health check failed (may still be starting)"
    fi
}

check_service "n8n" "{{ n8n_port }}" "/healthz"
check_service "ollama" "{{ ollama_port }}" "/api/tags"
check_service "qdrant" "{{ qdrant_port }}" "/healthz"
check_service "crawl4ai" "{{ crawl4ai_port }}" "/health"

# Mark initialization complete
touch "$GUARD_FILE"
rm -f "$ERROR_GUARD"

echo "==================================="
echo "GeuseMaker initialization complete!"
echo "Stack: {{ stack_name }}"
echo "All services should be accessible"
echo "Check status: docker-compose -f /root/docker-compose.yml ps"
echo "View logs: docker-compose -f /root/docker-compose.yml logs"
echo "==================================="
