# ===================================
# Docker Installation
# ===================================

echo "Docker Installation"

DOCKER_GUARD="/var/lib/geusemaker/docker-installed"

# NOTE: Docker's /var/lib/docker stays on local EBS storage (not EFS)
# EFS doesn't support all filesystem features needed by Docker's overlay2 driver
# Application data (n8n, Ollama, Qdrant, etc.) uses EFS via bind mounts in docker-compose.yml

if [ -f "$DOCKER_GUARD" ]; then
    echo "Docker already installed, skipping installation"
else
    echo "Installing Docker from official repository..."

    pkg_update_once

    install_compose_plugin_from_bundle() {
        local bundle_dir="${GEUSEMAKER_RUNTIME_DIR:-/opt/geusemaker/runtime}"
        local candidate=""

        if [ -d "$bundle_dir/docker/cli-plugins" ]; then
            candidate=$(find "$bundle_dir/docker/cli-plugins" -maxdepth 1 -type f -name "docker-compose*" | head -n1 || true)
        fi
        if [ -z "$candidate" ] && [ -d "$bundle_dir/bin" ]; then
            candidate=$(find "$bundle_dir/bin" -maxdepth 1 -type f -name "docker-compose*" | head -n1 || true)
        fi

        if [ -z "$candidate" ]; then
            return 1
        fi

        echo "Installing Docker Compose plugin from bundled file: $candidate"
        mkdir -p /usr/local/lib/docker/cli-plugins
        cp "$candidate" /usr/local/lib/docker/cli-plugins/docker-compose
        chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
        return 0
    }

    # Install Docker based on OS
    if [ "$OS_FAMILY" = "debian" ]; then
        echo "Setting up Docker repository for Debian/Ubuntu..."

        # Remove conflicting packages in parallel
        for pkg in docker.io docker-doc docker-compose docker-compose-v2 podman-docker containerd runc; do
            with_dpkg_lock_retry apt-get remove -y "$pkg" || true
        done

        # Install prerequisites (ca-certificates and curl already installed in base.sh.j2, but ensure they're present)
        install -m 0755 -d /etc/apt/keyrings

        # Add Docker's official GPG key (with timeout to prevent hanging)
        curl -fsSL --connect-timeout 10 --max-time 30 https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
        chmod a+r /etc/apt/keyrings/docker.asc

        # Add Docker repository
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
          $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
          tee /etc/apt/sources.list.d/docker.list > /dev/null

        # Update package list and install all Docker packages in single transaction
        with_dpkg_lock_retry apt-get update -y
        pkg_install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    else
        # Amazon Linux
        if command -v amazon-linux-extras >/dev/null 2>&1; then
            amazon-linux-extras install docker -y
        else
            pkg_install docker
        fi

        # Install Docker Compose plugin for Amazon Linux
        if ! install_compose_plugin_from_bundle; then
            DOCKER_COMPOSE_VERSION="2.24.5"
            DOCKER_COMPOSE_ARCH="$(uname -m)"
            case "$DOCKER_COMPOSE_ARCH" in
                x86_64|amd64)
                    DOCKER_COMPOSE_ARCH="x86_64"
                    ;;
                aarch64|arm64)
                    DOCKER_COMPOSE_ARCH="aarch64"
                    ;;
                *)
                    echo "ERROR: Unsupported architecture for docker-compose: $DOCKER_COMPOSE_ARCH"
                    exit 1
                    ;;
            esac
            mkdir -p /usr/local/lib/docker/cli-plugins
            if ! curl -SL --connect-timeout 10 --max-time 60 "https://github.com/docker/compose/releases/download/v${DOCKER_COMPOSE_VERSION}/docker-compose-linux-${DOCKER_COMPOSE_ARCH}" \
                -o /usr/local/lib/docker/cli-plugins/docker-compose; then
                echo "ERROR: Failed to download docker-compose for arch ${DOCKER_COMPOSE_ARCH}"
                exit 1
            fi
            chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
        fi
    fi

    # Docker's /var/lib/docker stays on local EBS (default location)
    # Application data persists on EFS via bind mounts defined in docker-compose.yml

    # Start and enable Docker service
    systemctl start docker
    systemctl enable docker

    # Add primary user to docker group
    primary_user="$(get_primary_user)"
    if [ -n "$primary_user" ]; then
        usermod -aG docker "$primary_user"
    fi

{% if tier == "gpu" %}
    # Install NVIDIA Docker runtime for GPU support
    echo "Installing NVIDIA Docker runtime..."
    distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
    if [ "$OS_FAMILY" = "debian" ]; then
        curl -fsSL --connect-timeout 10 --max-time 30 https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/libnvidia-container.gpg
        curl -s -L --connect-timeout 10 --max-time 30 https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
            sed "s#deb https://#deb [signed-by=/usr/share/keyrings/libnvidia-container.gpg] https://#" | \
            tee /etc/apt/sources.list.d/libnvidia-container.list
        pkg_update
        pkg_install nvidia-container-toolkit
    else
        curl -s -L --connect-timeout 10 --max-time 30 https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
            tee /etc/yum.repos.d/nvidia-container-toolkit.repo
        pkg_update
        pkg_install nvidia-container-toolkit
    fi
    nvidia-ctk runtime configure --runtime=docker
    systemctl restart docker
{% endif %}

    # Ensure docker compose plugin is present (Debian/Ubuntu may still be overridden by bundle)
    install_compose_plugin_from_bundle || true

    # Verify Docker is running
    if ! docker info > /dev/null 2>&1; then
        echo "ERROR: Docker is not running"
        exit 1
    fi

    echo "Docker installed successfully"
    echo "Docker version: $(docker --version)"

    # Show Docker Compose version (plugin or standalone)
    if docker compose version > /dev/null 2>&1; then
        echo "Docker Compose version: $(docker compose version)"
    elif command -v docker-compose > /dev/null 2>&1; then
        echo "Docker Compose version: $(docker-compose --version)"
    else
        echo "WARNING: Docker Compose not available"
    fi

    touch "$DOCKER_GUARD"
fi
