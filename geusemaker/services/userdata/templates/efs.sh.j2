# ===================================
# EFS Mount Configuration
# ===================================

echo "EFS Mount Configuration"

EFS_GUARD="/var/lib/geusemaker/efs-mounted"
if [ -f "$EFS_GUARD" ]; then
    echo "EFS already mounted, skipping"
else
    echo "Mounting EFS filesystem..."

    install_efs_utils_from_bundle() {
        local bundle_dir="${GEUSEMAKER_RUNTIME_DIR:-/opt/geusemaker/runtime}/efs-utils"
        if [ ! -d "$bundle_dir" ]; then
            return 1
        fi

        local deb_pkg rpm_pkg
        deb_pkg=$(find "$bundle_dir" -maxdepth 1 -name "amazon-efs-utils*.deb" | head -n1 || true)
        rpm_pkg=$(find "$bundle_dir" -maxdepth 1 -name "amazon-efs-utils*.rpm" | head -n1 || true)

        if [ -n "$deb_pkg" ]; then
            echo "Installing amazon-efs-utils from bundled .deb: $deb_pkg"
            with_dpkg_lock_retry dpkg -i "$deb_pkg" || true
            with_dpkg_lock_retry apt-get install -f -y || true
            return 0
        fi

        if [ -n "$rpm_pkg" ]; then
            echo "Installing amazon-efs-utils from bundled .rpm: $rpm_pkg"
            if command -v yum >/dev/null 2>&1; then
                yum localinstall -y "$rpm_pkg" || true
            elif command -v rpm >/dev/null 2>&1; then
                rpm -Uvh "$rpm_pkg" || true
            fi
            return 0
        fi

        return 1
    }

    # Install EFS utils (supports Amazon Linux and Ubuntu)
    pkg_update_once

    EFS_MOUNT_ADDR="{{ efs_mount_target_ip | default('', true) }}"
    EFS_MOUNT_HOST="{{ efs_dns }}"
    if [ -z "$EFS_MOUNT_ADDR" ]; then
        echo "ERROR: EFS mount target IP not provided; cannot mount without DNS."
        exit 1
    fi
    # Pin DNS to the mount target IP to avoid amazon-efs-utils DNS/DescribeMountTargets lookups
    if ! grep -q "$EFS_MOUNT_HOST" /etc/hosts; then
        echo "$EFS_MOUNT_ADDR $EFS_MOUNT_HOST" >> /etc/hosts
    fi
    echo "Using EFS mount target IP: $EFS_MOUNT_ADDR"

    if install_efs_utils_from_bundle; then
        echo "amazon-efs-utils installed from bundled artifacts"
    else
        # Try package manager installation (may fail on Ubuntu)
        set +e
        pkg_install amazon-efs-utils 2>&1
        set -e

        # Verify installation by checking if mount.efs exists
        if command -v mount.efs >/dev/null 2>&1 || [ -x /sbin/mount.efs ]; then
            echo "amazon-efs-utils installed successfully from package manager"
        elif [ "$OS_FAMILY" = "debian" ]; then
            echo "amazon-efs-utils not available via apt, attempting source build..."
            # Install all build dependencies in single transaction for performance
            # (runtime deps like stunnel4 and nfs-common already installed in base.sh.j2)
            pkg_install git binutils build-essential pkg-config libssl-dev rustc cargo golang-go cmake

            TMP_EFS_DIR=$(mktemp -d)
            echo "Cloning efs-utils repository to $TMP_EFS_DIR..."

            if ! git clone --depth 1 https://github.com/aws/efs-utils "$TMP_EFS_DIR" 2>&1; then
                echo "ERROR: Failed to clone efs-utils repository"
                rm -rf "$TMP_EFS_DIR"
                exit 1
            fi

            cd "$TMP_EFS_DIR"
            echo "Building amazon-efs-utils .deb package..."

            if ! ./build-deb.sh 2>&1; then
                echo "ERROR: Failed to build amazon-efs-utils .deb package"
                echo "Check build logs above for details"
                cd /
                rm -rf "$TMP_EFS_DIR"
                exit 1
            fi

            # Verify .deb was created
            if ! ls ./build/amazon-efs-utils*.deb >/dev/null 2>&1; then
                echo "ERROR: amazon-efs-utils .deb package not found in ./build/"
                ls -la ./build/ || true
                cd /
                rm -rf "$TMP_EFS_DIR"
                exit 1
            fi

            echo "Installing amazon-efs-utils .deb package..."
            # Install the built package
            if ! with_dpkg_lock_retry dpkg -i ./build/amazon-efs-utils*.deb 2>&1; then
                echo "WARNING: dpkg installation had errors, attempting to fix dependencies..."
                # Fix any dependency issues automatically
                with_dpkg_lock_retry apt-get install -f -y
            fi

            cd /
            rm -rf "$TMP_EFS_DIR"
        else
            echo "ERROR: Failed to install amazon-efs-utils (non-Debian system)"
            exit 1
        fi
    fi

    # Final verification that mount helper exists
    if ! command -v mount.efs >/dev/null 2>&1 && [ ! -x /sbin/mount.efs ]; then
        echo "ERROR: amazon-efs-utils installation failed; mount.efs helper not found."
        echo "Diagnostics:"
        echo "  - Searching for mount.efs:"
        find /usr -name "mount.efs" -o -name "mount.efs*" 2>/dev/null || echo "    Not found in /usr"
        find /sbin -name "mount.efs" -o -name "mount.efs*" 2>/dev/null || echo "    Not found in /sbin"
        echo "  - amazon-efs-utils package status:"
        if command -v dpkg >/dev/null 2>&1; then
            dpkg -l | grep efs-utils || echo "    Package not found in dpkg"
        elif command -v rpm >/dev/null 2>&1; then
            rpm -qa | grep efs-utils || echo "    Package not found in rpm"
        fi
        exit 1
    fi

    echo "amazon-efs-utils installed successfully (mount.efs helper verified)"

    # Create mount point
    mkdir -p /mnt/efs

    # Mount EFS with TLS encryption, IAM auth, and pinned mount target IP (bypasses DescribeMountTargets)
    MOUNT_OPTS="tls,iam,addr=${EFS_MOUNT_ADDR}"
    MOUNT_LOG="/var/log/amazon/efs/mount.log"
    mkdir -p "$(dirname "$MOUNT_LOG")"

    if ! mount -t efs -o "$MOUNT_OPTS" {{ efs_id }}:/ /mnt/efs 2> /tmp/efs-mount.err; then
        echo "ERROR: EFS mount failed with IAM authentication (options: $MOUNT_OPTS)"
        if [ -s /tmp/efs-mount.err ]; then
            echo "--- mount stderr ---"
            cat /tmp/efs-mount.err
        fi
        if [ -f "$MOUNT_LOG" ]; then
            echo "--- amazon-efs-utils log (tail) ---"
            tail -n 50 "$MOUNT_LOG"
        fi
        exit 1
    fi
    rm -f /tmp/efs-mount.err

    # Verify mount
    if ! mountpoint -q /mnt/efs; then
        echo "ERROR: EFS mount succeeded but mountpoint check failed; ensure NFS (2049) is allowed from the instance."
        exit 1
    fi

    # Add to fstab for persistence
    if ! grep -q "{{ efs_id }}" /etc/fstab; then
        echo "{{ efs_id }}:/ /mnt/efs efs _netdev,tls,iam,addr=${EFS_MOUNT_ADDR} 0 0" >> /etc/fstab
    fi

    # Create service data directories (application data only - Docker stays on local EBS)
    mkdir -p /mnt/efs/n8n
    mkdir -p /mnt/efs/ollama
    mkdir -p /mnt/efs/qdrant
    mkdir -p /mnt/efs/postgres

    # Set permissions for each service directory
    # n8n runs as UID 1000 (node user) - needs write access
    chmod 777 /mnt/efs/n8n
    # ollama runs as UID 0 (root) - needs write access
    chmod 777 /mnt/efs/ollama
    # qdrant runs as UID 999 (qdrant user) - needs write access
    chmod 777 /mnt/efs/qdrant
    # postgres runs as UID 999 (postgres user) - needs write access
    chmod 777 /mnt/efs/postgres
    # Root directory permissions
    chmod 755 /mnt/efs

    echo "EFS mounted successfully at /mnt/efs"
    echo "EFS ID: {{ efs_id }}"
    echo "EFS DNS: {{ efs_dns }}"
    echo "EFS Mount Target IP: $EFS_MOUNT_ADDR"

    touch "$EFS_GUARD"
fi
