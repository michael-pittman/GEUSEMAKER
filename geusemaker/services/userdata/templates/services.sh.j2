# ===================================
# Docker Compose Service Setup
# ===================================

SERVICES_GUARD="/var/lib/geusemaker/services-started"
if [ -f "$SERVICES_GUARD" ]; then
    echo "Services already started, skipping"
else
    echo "Configuring Docker Compose services..."

    use_runtime_bundle="{{ 'true' if use_runtime_bundle else 'false' }}"

    run_compose() {
        if command -v docker-compose >/dev/null 2>&1; then
            docker-compose -f "$COMPOSE_FILE_PATH" "$@"
        else
            docker compose -f "$COMPOSE_FILE_PATH" "$@"
        fi
    }

    write_runtime_env() {
        local env_dir
        env_dir="$(dirname "$RUNTIME_ENV_FILE")"
        mkdir -p "$env_dir"
        cat > "$RUNTIME_ENV_FILE" <<'EOF'
N8N_PORT={{ n8n_port }}
OLLAMA_PORT={{ ollama_port }}
QDRANT_PORT={{ qdrant_port }}
CRAWL4AI_PORT={{ crawl4ai_port }}
POSTGRES_PASSWORD={{ postgres_password }}
N8N_METRICS={{ "true" if tier == "automation" or tier == "gpu" else "false" }}
DOCKER_RUNTIME={{ "nvidia" if tier == "gpu" else "runc" }}
NVIDIA_VISIBLE_DEVICES={{ "all" if tier == "gpu" else "" }}
EOF
{% for key, value in custom_env.items() %}
        printf "%s\n" "{{ key }}={{ value }}" >> "$RUNTIME_ENV_FILE"
{% endfor %}
    }

    write_compose_file() {
        cat > "$COMPOSE_FILE_PATH" <<'EOF'
version: "3.8"

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    env_file:
      - ./runtime.env
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:${N8N_PORT:-5678}/
      - N8N_METRICS=${N8N_METRICS:-false}
    ports:
      - "${N8N_PORT:-5678}:5678"
    volumes:
      - /mnt/efs/n8n:/home/node/.n8n
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    env_file:
      - ./runtime.env
    runtime: ${DOCKER_RUNTIME:-runc}
    environment:
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-}
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - /mnt/efs/ollama:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3

  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    env_file:
      - ./runtime.env
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "6334:6334"
    volumes:
      - /mnt/efs/qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  crawl4ai:
    image: unclecode/crawl4ai:latest
    container_name: crawl4ai
    restart: unless-stopped
    env_file:
      - ./runtime.env
    ports:
      - "${CRAWL4AI_PORT:-11235}:11235"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11235/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15
    container_name: postgres
    restart: unless-stopped
    env_file:
      - ./runtime.env
    environment:
      - POSTGRES_DB=geusemaker
      - POSTGRES_USER=geusemaker
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
    volumes:
      - /mnt/efs/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U geusemaker"]
      interval: 30s
      timeout: 10s
      retries: 3
EOF
    }

    load_prebaked_images() {
        local images_dir="${GEUSEMAKER_RUNTIME_DIR:-/opt/geusemaker/runtime}/images"
        if [ ! -d "$images_dir" ]; then
            return
        fi
        shopt -s nullglob
        for tarball in "$images_dir"/*.tar "$images_dir"/*.tar.gz; do
            [ -e "$tarball" ] || continue
            echo "Loading pre-baked Docker image $tarball"
            docker load -i "$tarball" || true
        done
        shopt -u nullglob
    }

    write_runtime_env

    if [ "$use_runtime_bundle" = "true" ]; then
        if [ ! -f "$COMPOSE_FILE_PATH" ]; then
            echo "ERROR: Runtime bundle compose not found at $COMPOSE_FILE_PATH"
            exit 1
        fi
    else
        write_compose_file
    fi

    load_prebaked_images

    echo "Pre-pulling Docker images to EFS-backed data directory..."
    run_compose pull

    echo "Starting Docker Compose services..."
    run_compose up -d

    # Wait for services to start
    sleep 10

    # Verify containers are running
    if ! run_compose ps | grep -q "Up"; then
        echo "WARNING: Some containers may not be running"
        run_compose ps
    else
        echo "All services started successfully"
        run_compose ps
    fi

    touch "$SERVICES_GUARD"
fi
