# ===================================
# n8n Credential Preloading
# ===================================
# Preloads n8n with credentials for stack services (PostgreSQL, Ollama, Qdrant, Crawl4AI)
# This enables workflows to run immediately without manual credential configuration

N8N_CREDENTIALS_GUARD="/var/lib/geusemaker/n8n-credentials-configured"
if [ -f "$N8N_CREDENTIALS_GUARD" ]; then
    echo "n8n credentials already configured, skipping"
else
    echo "Configuring n8n credentials for stack services..."

    # Wait for n8n API to be ready
    wait_for_n8n_api() {
        local max_attempts=60
        local attempt=1
        local delay=5

        echo "Waiting for n8n API to be ready..."
        while [ $attempt -le $max_attempts ]; do
            if curl -sf --connect-timeout 5 --max-time 10 "http://localhost:{{ n8n_port }}/healthz" > /dev/null 2>&1; then
                # Additional check: ensure n8n has finished initializing (check for /rest/login endpoint)
                if curl -sf --connect-timeout 5 --max-time 10 "http://localhost:{{ n8n_port }}/rest/login" > /dev/null 2>&1; then
                    echo "n8n API is ready"
                    return 0
                fi
            fi
            if [ $attempt -lt $max_attempts ]; then
                echo "  Waiting for n8n API... (attempt $attempt/$max_attempts)"
                sleep $delay
            fi
            attempt=$((attempt + 1))
        done

        echo "WARNING: n8n API not ready after $max_attempts attempts, skipping credential preloading"
        return 1
    }

    # Prepare n8n API authentication
    # n8n supports multiple auth methods:
    # 1. Owner API key (N8N_USER_MANAGEMENT_OWNER_API_KEY env var)
    # 2. Basic auth (N8N_BASIC_AUTH_ACTIVE=true)
    # 3. Cookie-based session (requires initial login)
    prepare_n8n_auth() {
        local n8n_url="http://localhost:{{ n8n_port }}"
        
        # Check if owner API key is available (most reliable method)
        local owner_api_key
        owner_api_key=$(docker exec n8n printenv N8N_USER_MANAGEMENT_OWNER_API_KEY 2>/dev/null || echo "")
        
        if [ -n "$owner_api_key" ]; then
            echo "Using n8n owner API key for authentication"
            export N8N_API_KEY="$owner_api_key"
            return 0
        fi

        # Check if basic auth is enabled
        local basic_auth_active
        basic_auth_active=$(docker exec n8n printenv N8N_BASIC_AUTH_ACTIVE 2>/dev/null || echo "")
        
        if [ "$basic_auth_active" = "true" ]; then
            local basic_auth_user
            local basic_auth_password
            basic_auth_user=$(docker exec n8n printenv N8N_BASIC_AUTH_USER 2>/dev/null || echo "")
            basic_auth_password=$(docker exec n8n printenv N8N_BASIC_AUTH_PASSWORD 2>/dev/null || echo "")
            
            if [ -n "$basic_auth_user" ] && [ -n "$basic_auth_password" ]; then
                echo "Using n8n basic auth for authentication"
                export N8N_BASIC_AUTH_USER="$basic_auth_user"
                export N8N_BASIC_AUTH_PASSWORD="$basic_auth_password"
                return 0
            fi
        fi

        # Fallback: Try to access API without auth (may work if no auth is configured)
        echo "WARNING: No API authentication configured, attempting unauthenticated access"
        echo "  Note: n8n may require authentication to persist credentials via API"
        echo "  If credential creation fails, configure one of:"
        echo "    - N8N_USER_MANAGEMENT_OWNER_API_KEY (recommended)"
        echo "    - N8N_BASIC_AUTH_ACTIVE=true with N8N_BASIC_AUTH_USER/PASSWORD"
        return 0
    }

    # Create PostgreSQL credential in n8n
    create_postgres_credential() {
        local n8n_url="http://localhost:{{ n8n_port }}"
        local credential_name="PostgreSQL Local"
        local credential_id="postgres-local"

        echo "Creating PostgreSQL credential: $credential_name"

        # Build curl command with appropriate authentication for check
        local curl_auth_args_check=()
        if [ -n "${N8N_API_KEY:-}" ]; then
            curl_auth_args_check=(-H "X-N8N-API-KEY: $N8N_API_KEY")
        elif [ -n "${N8N_BASIC_AUTH_USER:-}" ] && [ -n "${N8N_BASIC_AUTH_PASSWORD:-}" ]; then
            curl_auth_args_check=(-u "$N8N_BASIC_AUTH_USER:$N8N_BASIC_AUTH_PASSWORD")
        fi

        # Check if credential already exists
        local existing
        existing=$(curl -s -b /tmp/n8n-cookies.txt -c /tmp/n8n-cookies.txt \
            ${curl_auth_args_check[@]+"${curl_auth_args_check[@]}"} \
            "$n8n_url/rest/credentials" 2>/dev/null | grep -o "\"id\":\"$credential_id\"" || true)

        if [ -n "$existing" ]; then
            echo "  PostgreSQL credential already exists, skipping"
            return 0
        fi

        # Create PostgreSQL credential
        # n8n credential format: { "name": "...", "type": "postgres", "data": { ... } }
        local postgres_password
        postgres_password="{{ postgres_password }}"

        local credential_data
        credential_data=$(cat <<EOF
{
  "name": "$credential_name",
  "type": "postgres",
  "data": {
    "host": "postgres",
    "port": 5432,
    "database": "geusemaker",
    "user": "geusemaker",
    "password": "$postgres_password",
    "allowReconnection": true,
    "ssl": {
      "rejectUnauthorized": false
    }
  }
}
EOF
)

        # Build curl command with appropriate authentication
        local curl_auth_args=()
        if [ -n "${N8N_API_KEY:-}" ]; then
            curl_auth_args=(-H "X-N8N-API-KEY: $N8N_API_KEY")
        elif [ -n "${N8N_BASIC_AUTH_USER:-}" ] && [ -n "${N8N_BASIC_AUTH_PASSWORD:-}" ]; then
            curl_auth_args=(-u "$N8N_BASIC_AUTH_USER:$N8N_BASIC_AUTH_PASSWORD")
        fi

        local response
        response=$(curl -s -w "\n%{http_code}" -b /tmp/n8n-cookies.txt -c /tmp/n8n-cookies.txt \
            ${curl_auth_args[@]+"${curl_auth_args[@]}"} \
            -X POST "$n8n_url/rest/credentials" \
            -H "Content-Type: application/json" \
            -d "$credential_data" 2>&1)

        local http_code
        http_code=$(echo "$response" | tail -n1)
        local body
        body=$(echo "$response" | sed '$d')

        if [ "$http_code" = "200" ] || [ "$http_code" = "201" ]; then
            # Verify credential was actually created by checking if it exists
            sleep 2  # Give n8n time to persist
            local verify_check
            verify_check=$(curl -s -b /tmp/n8n-cookies.txt -c /tmp/n8n-cookies.txt \
                ${curl_auth_args_check[@]+"${curl_auth_args_check[@]}"} \
                "$n8n_url/rest/credentials" 2>/dev/null | grep -o "\"id\":\"$credential_id\"" || true)
            
            if [ -n "$verify_check" ]; then
                echo "  ✓ PostgreSQL credential created successfully and verified"
                return 0
            else
                echo "  ✗ Credential creation reported success (HTTP $http_code) but credential not found"
                echo "    This usually means n8n requires authentication to persist credentials"
                echo "    Response body: $body"
                return 1
            fi
        elif echo "$body" | grep -q "already exists\|duplicate"; then
            echo "  ✓ PostgreSQL credential already exists"
            return 0
        else
            echo "  ✗ Failed to create PostgreSQL credential (HTTP $http_code)"
            echo "    Response: $body"
            # Don't fail - credentials can be created manually
            return 1
        fi
    }

    # Create HTTP Request credential for a service (Ollama, Qdrant, Crawl4AI)
    create_http_credential() {
        local service_name=$1
        local credential_name=$2
        local base_url=$3

        echo "Creating HTTP credential for $service_name: $credential_name"

        local n8n_url="http://localhost:{{ n8n_port }}"
        local credential_data
        credential_data=$(cat <<EOF
{
  "name": "$credential_name",
  "type": "httpBasicAuth",
  "data": {
    "user": "",
    "password": ""
  }
}
EOF
)

        # Note: For services without auth, we can create a generic HTTP credential
        # or use httpHeaderAuth with empty headers. However, since workflows use
        # authentication: "none", credentials may not be strictly necessary.
        # This is optional and can be skipped if not needed.

        echo "  ⚠ HTTP credentials for $service_name are optional (workflows use authentication: none)"
        return 0
    }

    # Main credential setup
    if wait_for_n8n_api; then
        if prepare_n8n_auth; then
            # Create PostgreSQL credential (required by workflows)
            if create_postgres_credential; then
                echo "n8n credential preloading completed successfully"
            else
                echo "WARNING: PostgreSQL credential creation failed"
                if [ -z "${N8N_API_KEY:-}" ] && [ -z "${N8N_BASIC_AUTH_USER:-}" ]; then
                    echo "  This is likely because n8n requires authentication to persist credentials via API"
                    echo "  To enable automatic credential creation, configure one of:"
                    echo "    - N8N_USER_MANAGEMENT_OWNER_API_KEY (recommended)"
                    echo "    - N8N_BASIC_AUTH_ACTIVE=true with N8N_BASIC_AUTH_USER/PASSWORD"
                    echo ""
                    echo "  Manual credential setup:"
                    echo "    1. Log into n8n UI: http://<public-ip>:5678"
                    echo "    2. Go to Credentials → New → PostgreSQL"
                    echo "    3. Name: PostgreSQL Local"
                    echo "    4. Host: postgres, Port: 5432, Database: geusemaker"
                    echo "    5. User: geusemaker, Password: (from /mnt/efs/runtime.env)"
                else
                    echo "  Credential creation failed despite authentication being configured"
                    echo "  Please create the credential manually in the n8n UI"
                fi
            fi

            # Note: Ollama, Qdrant, and Crawl4AI don't require credentials in current workflows
            # (they use HTTP requests with authentication: "none")
            # If you need HTTP credentials for these services, uncomment below:
            # create_http_credential "Ollama" "Ollama Local" "http://ollama:11434"
            # create_http_credential "Qdrant" "Qdrant Local" "http://qdrant:6333"
            # create_http_credential "Crawl4AI" "Crawl4AI Local" "http://crawl4ai:11235"
        else
            echo "WARNING: Could not prepare n8n authentication, credentials must be created manually"
            echo "  To enable automatic credential creation, set one of:"
            echo "  - N8N_USER_MANAGEMENT_OWNER_API_KEY (recommended)"
            echo "  - N8N_BASIC_AUTH_ACTIVE=true with N8N_BASIC_AUTH_USER/PASSWORD"
            echo ""
            echo "  Manual credential setup:"
            echo "  - PostgreSQL: postgres:5432/geusemaker (user: geusemaker, password from runtime.env)"
        fi
    else
        echo "WARNING: n8n API not ready, skipping credential preloading"
        echo "  Credentials can be created manually after n8n is accessible"
    fi

    # Cleanup
    rm -f /tmp/n8n-cookies.txt

    touch "$N8N_CREDENTIALS_GUARD"
fi

